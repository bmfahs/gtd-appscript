<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --border-radius: 8px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .header p {
            color: var(--text-secondary);
            margin: 0;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0 0 20px 0;
            line-height: 1.5;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            font-family: inherit;
            font-weight: 500;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-primary:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-secondary:disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .log-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-top: 24px;
            box-shadow: var(--shadow);
        }

        .log-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-actions {
            font-size: 12px;
            color: var(--primary);
            cursor: pointer;
        }

        .log-content {
            padding: 16px;
            height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 4px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        .log-time {
            color: #569cd6;
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Import & Scan</h1>
            <p>Process emails and sync your inbox without blocking your workflow.</p>
        </div>

        <div class="grid">
            <div class="card">
                <h2><span class="material-icons">download</span> Import from Gmail</h2>
                <p>Imports all email threads labeled <strong>GTD/ToProcess</strong> into the system as new inbox tasks.
                </p>
                <button id="btnImport" class="btn btn-primary" onclick="importGmail()">Start Import</button>
            </div>

            <div class="card">
                <h2><span class="material-icons">psychology</span> AI Inbox Scan</h2>
                <p>Uses AI to analyze task contents, suggest contexts, project assignments, and identify next actions
                    automatically.</p>
                <button id="btnScan" class="btn btn-secondary" onclick="scanInbox()">Start AI Scan</button>
            </div>
        </div>

        <div class="log-container">
            <div class="log-header">
                Activity Log
                <span class="log-actions" onclick="clearLog()">Clear Log</span>
            </div>
            <div id="importLog" class="log-content">
                <div class="log-entry">System ready. Select a process to begin.</div>
            </div>
        </div>
    </div>

    <script>
        function log(msg) {
            var el = document.getElementById('importLog');
            var time = new Date().toLocaleTimeString();
            var line = '<div class="log-entry"><span class="log-time">[' + time + ']</span> ' + msg + '</div>';
            el.innerHTML += line;
            el.scrollTop = el.scrollHeight;
        }

        function clearLog() {
            document.getElementById('importLog').innerHTML = '';
        }

        function setBusy(busy) {
            document.getElementById('btnImport').disabled = busy;
            document.getElementById('btnScan').disabled = busy;
        }

        function importGmail() {
            setBusy(true);
            log('Starting import from Gmail (Label: GTD/ToProcess)...');

            google.script.run
                .withSuccessHandler(function (r) {
                    setBusy(false);
                    if (r.success) {
                        log('SUCCESS: Imported ' + r.count + ' tasks.');
                        log('You can close this tab or run another scan.');
                    } else {
                        log('ERROR: ' + r.error);
                    }
                })
                .withFailureHandler(function (e) {
                    setBusy(false);
                    log('SYSTEM ERROR: ' + e);
                })
                .importGmailTasks(); // Calls backend function directly
        }

        function scanInbox() {
            var totalProcessed = 0;
            var isScanning = true;

            setBusy(true);
            log('Initializing AI Scan...');

            function runBatch() {
                if (!isScanning) return;

                log('Batch processing... (Total so far: ' + totalProcessed + ')');

                google.script.run
                    .withSuccessHandler(function (r) {
                        totalProcessed += r.count;
                        log('Batch Result: Processed ' + r.count + ' items. Threads analyzed: ' + r.threadsFound);

                        if (r.complete) {
                            log('COMPLETED: Scan finished. Total Processed: ' + totalProcessed);
                            setBusy(false);
                            isScanning = false;
                        } else if (r.count === 0 && r.threadsFound > 0) {
                            // Stagnation
                            var errorMsg = r.error ? ': ' + r.error : '.';
                            log('ABORTED: Found threads but could not process. Error' + errorMsg);
                            log('Suggestion: Check quota or backend logs.');
                            setBusy(false);
                            isScanning = false;
                        } else {
                            // Continue scanning
                            runBatch();
                        }
                    })
                    .withFailureHandler(function (e) {
                        setBusy(false);
                        log('SYSTEM ERROR: ' + e);
                        isScanning = false;
                    })
                    .scanInboxForSuggestions(); // Calls backend function directly
            }

            // Note: scanInbox in Index.html called a wrapper or the backend function?
            // In Code.gs, there isn't a 'scanInbox' function exposed directly in the snippets I saw earlier.
            // Let's verify if `scanInbox` is in Code.gs.
            // Earlier greps showed `importGmailTasks` logic.
            // I need to be sure `scanInbox` is exposed or if it was a client-side loop calling `processBatch`?
            // Re-checking Index.html logic.
            runBatch();
        }
    </script>
</body>

</html>