<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --sidebar-width: 240px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .select-options {
            display: none;
            position: fixed;
            /* Changed from absolute to fixed */
            /* Top/Left/Width will be set by JS */
            max-height: 300px;
            /* Increased height */
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            z-index: 1000;
            /* Higher than dialog-overlay (200) */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .select-options.show {
            display: block;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius);
        }

        .menu-toggle:hover {
            background: var(--bg-tertiary);
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            position: relative;
            margin-right: 16px;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-bar .material-icons {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            font-size: 20px;
        }

        .quick-capture {
            flex: 1;
            max-width: 600px;
            display: flex;
            gap: 8px;
        }

        .quick-capture input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .quick-capture input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .header-right {
            display: flex;
            gap: 12px;
        }

        .header-right select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 13px;
            background: var(--bg-primary);
        }

        .main-container {
            display: flex;
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }

        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 16px 0;
            z-index: 90;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            padding: 0 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.15s;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .nav-item .material-icons {
            font-size: 20px;
        }

        .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .badge:empty {
            display: none;
        }

        .content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            max-width: 1000px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-muted);
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .page-header p {
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .task-list {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            /* overflow: hidden; Removed to allow dropdowns */
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item:hover {
            background: var(--bg-tertiary);
        }

        .task-item.selected,
        .project-card.selected {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--primary);
            padding-left: 9px;
            /* Adjust for border */
        }

        .task-checkbox {
            width: 18px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .task-checkbox:hover {
            border-color: var(--primary);
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-weight: 500;
            color: var(--text-primary);
            word-break: break-word;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .context-group {
            margin-bottom: 24px;
        }

        .context-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            font-weight: 600;
            color: var(--text-primary);
        }

        .context-icon {
            font-size: 18px;
        }

        .project-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .project-card:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .project-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        .project-stats {
            font-size: 12px;
            color: var(--text-muted);
        }

        .project-description {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state .material-icons {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius);
            color: var(--text-secondary);
        }

        .btn-icon:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 24px;
        }

        .dialog {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 100%;
            max-width: 560px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .dialog-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .dialog-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .dialog-content {
            padding: 20px;
            overflow-y: auto;
        }

        .dialog-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .dialog-footer-right {
            display: flex;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea.form-control {
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .email-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            text-decoration: none;
            padding: 8px 12px;
            background: rgba(37, 99, 235, 0.1);
            border-radius: var(--border-radius);
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transition: all 0.3s;
            z-index: 300;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .review-section {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 24px;
        }

        .review-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .review-section h3 .material-icons {
            color: var(--primary);
        }

        .add-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-muted);
            cursor: pointer;
            width: 100%;
            transition: all 0.15s;
            margin-top: 8px;
        }

        .add-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .header {
                position: relative;
                height: auto;
                flex-wrap: wrap;
                padding: 12px 16px;
                gap: 0;
            }

            .header-left {
                width: 100%;
                margin-bottom: 12px;
                justify-content: flex-start;
            }

            .main-container {
                margin-top: 0;
            }

            .search-bar {
                width: 100%;
                flex: none;
                /* Force full width */
                margin-right: 0;
                margin-bottom: 8px;
                max-width: none;
            }

            .quick-capture {
                width: 100%;
                flex: none;
                max-width: none;
            }

            .menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
                top: 0;
                height: 100vh;
                z-index: 1000;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .content {
                margin-left: 0;
            }

            .header-right {
                display: none;
            }

            .form-row {
                grid-template-columns: 1fr;
            }


            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .dialog {
                max-width: none;
                margin: 0;
                border-radius: 0;
                width: 95%;
                max-height: 100vh;
            }
        }

        .custom-select-container {
            position: relative;
        }

        .custom-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: var(--text-primary);
        }

        .dropdown-item:hover {
            background-color: var(--bg-secondary);
        }

        .dropdown-item.level-0 {
            padding-left: 12px;
        }

        .dropdown-item.level-1 {
            padding-left: 24px;
        }

        .dropdown-item.level-2 {
            padding-left: 36px;
        }

        .dropdown-item.level-3 {
            padding-left: 48px;
        }

        .dropdown-item.level-4 {
            padding-left: 60px;
        }

        .dropdown-item .project-icon {
            margin-right: 8px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .queue-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            /* Hidden by default */
            font-size: 13px;
        }

        .queue-header {
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .queue-item {
            padding: 8px 14px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-item:last-child {
            border-bottom: none;
        }

        .queue-item.processing {
            color: var(--primary);
        }

        .queue-item.error {
            color: var(--danger);
        }

        .queue-item .status-icon {
            font-size: 14px;
        }

        .queue-item.processing .status-icon {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="queueStatus" class="queue-status">
            <div class="queue-header">
                <span id="queueTitle">Syncing...</span>
                <span id="queueCount" class="badge">0</span>
            </div>
            <div id="queueList" class="queue-list"></div>
        </div>
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <span class="material-icons">menu</span>
                </button>
                <h1 class="logo">GTD</h1>
            </div>
            <div class="search-bar">
                <span class="material-icons">search</span>
                <input type="text" id="searchInput" placeholder="Search..." onkeyup="handleSearch(event)">
            </div>
            <div class="quick-capture">
                <input type="text" id="quickCaptureInput" placeholder="Quick capture... (press Enter)"
                    onkeypress="handleQuickCapture(event)">
                <button onclick="submitQuickCapture()" class="btn-icon">
                    <span class="material-icons">add</span>
                </button>
            </div>
            <div class="header-right">
                <select id="currentContext" onchange="updateCurrentContext()">
                    <option value="">All Contexts</option>
                </select>
                <select id="currentEnergy" onchange="updateCurrentEnergy()">
                    <option value="high">High Energy</option>
                    <option value="medium" selected>Medium Energy</option>
                    <option value="low">Low Energy</option>
                </select>
            </div>
        </header>
        <div class="main-container">
            <nav class="sidebar" id="sidebar">
                <div class="nav-section">
                    <div class="nav-section-title">Collect</div>
                    <a href="#" class="nav-item" data-page="inbox" onclick="navigateTo('inbox'); return false;">
                        <span class="material-icons">inbox</span><span>Inbox</span><span class="badge"
                            id="inboxBadge"></span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Do</div>
                    <a href="#" class="nav-item" data-page="next" onclick="navigateTo('next'); return false;">
                        <span class="material-icons">play_arrow</span><span>Next Actions</span><span class="badge"
                            id="nextActionsBadge"></span>
                    </a>
                    <a href="#" class="nav-item" data-page="today" onclick="navigateTo('today'); return false;">
                        <span class="material-icons">today</span><span>Today</span>
                    </a>
                    <a href="#" class="nav-item" data-page="scheduled" onclick="navigateTo('scheduled'); return false;">
                        <span class="material-icons">event</span><span>Scheduled</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Track</div>
                    <a href="#" class="nav-item" data-page="waiting" onclick="navigateTo('waiting'); return false;">
                        <span class="material-icons">hourglass_empty</span><span>Waiting For</span>
                    </a>
                    <a href="#" class="nav-item" data-page="projects" onclick="navigateTo('projects'); return false;">
                        <span class="material-icons">folder</span><span>Projects</span>
                    </a>
                    <a href="#" class="nav-item" data-page="all" onclick="navigateTo('all'); return false;">
                        <span class="material-icons">account_tree</span><span>All Tasks</span>
                    </a>
                    <a href="#" class="nav-item" onclick="navigateTo('attention'); return false;" data-page="attention">
                        <span class="material-icons">health_and_safety</span>
                        Attention
                        <span class="badge" id="attentionBadge"></span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Review</div>
                    <a href="#" class="nav-item" data-page="someday" onclick="navigateTo('someday'); return false;">
                        <span class="material-icons">cloud</span><span>Someday/Maybe</span>
                    </a>
                    <a href="#" class="nav-item" data-page="review" onclick="navigateTo('review'); return false;">
                        <span class="material-icons">rate_review</span><span>Weekly Review</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Organize</div>
                    <a href="#" class="nav-item" data-page="contexts" onclick="navigateTo('contexts'); return false;">
                        <span class="material-icons">label</span><span>Contexts</span>
                    </a>
                    <a href="#" class="nav-item" data-page="areas" onclick="navigateTo('areas'); return false;">
                        <span class="material-icons">category</span><span>Areas</span>
                    </a>
                </div>
            </nav>
            <main class="content" id="content">
                <div class="loading" id="loading">
                    <span class="material-icons spinning">refresh</span>
                    <p id="loading-text">Loading...</p>
                </div>
                <div id="pageContent"></div>
            </main>
        </div>
        <!-- Unified Item Dialog -->
        <div id="itemDialog" class="dialog-overlay" style="display: none;"
            onclick="if(event.target === this) closeItemDialog()">
            <div class="dialog">
                <div class="dialog-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <h2 id="itemDialogTitle">Edit Item</h2>
                        <button class="btn-icon" id="itemStarBtn" onclick="toggleItemStar()"
                            style="color:var(--text-muted);">
                            <span class="material-icons" id="itemStarIcon">star_border</span>
                        </button>
                    </div>
                    <button class="btn-icon" onclick="closeItemDialog()"><span
                            class="material-icons">close</span></button>
                </div>
                <div class="dialog-content">
                    <div class="form-group">
                        <label for="itemTitle">Title</label>
                        <input type="text" id="itemTitle" class="form-control" autocomplete="off">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemType">Type</label>
                            <select id="itemType" class="form-control" onchange="updateDialogVisibility()">
                                <option value="task">Task</option>
                                <option value="project">Project</option>
                                <option value="folder">Folder</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="itemStatus">Status</label>
                            <select id="itemStatus" class="form-control">
                                <option value="inbox">Inbox</option>
                                <option value="next">Next Action</option>
                                <option value="active">Active</option>
                                <option value="waiting">Waiting For</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="someday">Someday/Maybe</option>
                                <option value="done">Done/Completed</option>
                                <option value="dropped">Dropped</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="parentContainer">
                        <label for="itemParentDisplay">Parent (Project/Folder)</label>
                        <div class="custom-select-container" id="itemParentContainer">
                            <input type="text" id="itemParentDisplay" class="form-control"
                                placeholder="Search projects..." autocomplete="off">
                            <input type="hidden" id="itemParent">
                            <div id="itemParentDropdown" class="custom-select-dropdown" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Task Specific Fields -->
                    <div id="taskFields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="itemContext">Context</label>
                                <select id="itemContext" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label for="itemTimeEstimate">Time (min)</label>
                                <input type="number" id="itemTimeEstimate" class="form-control" placeholder="15">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="itemImportance">Importance</label>
                                <select id="itemImportance" class="form-control">
                                    <option value="1">Low</option>
                                    <option value="2">Normal</option>
                                    <option value="3">High</option>
                                    <option value="4">Top</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="itemUrgency">Urgency</label>
                                <select id="itemUrgency" class="form-control">
                                    <option value="1">Low</option>
                                    <option value="2">Normal</option>
                                    <option value="3">High</option>
                                    <option value="4">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="itemEnergy">Energy</label>
                                <select id="itemEnergy" class="form-control">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="form-group" id="itemWaitingForGroup" style="display:none">
                                <label for="itemWaitingFor">Waiting For (Who?)</label>
                                <input type="text" id="itemWaitingFor" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- Project/Folder Specific Fields -->
                    <div id="projectFields" style="display:none">
                        <div class="form-group">
                            <label for="itemArea">Area</label>
                            <select id="itemArea" class="form-control"></select>
                        </div>
                    </div>

                    <!-- Common Date Fields -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemDueDate">Due Date</label>
                            <input type="date" id="itemDueDate" class="form-control">
                        </div>
                        <div class="form-group" id="scheduledDateGroup">
                            <label for="itemScheduledDate">Scheduled Date</label>
                            <input type="date" id="itemScheduledDate" class="form-control">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemNotes">Notes</label>
                        <textarea id="itemNotes" class="form-control" rows="4"></textarea>
                    </div>

                    <div class="form-group" id="emailLink" style="display: none;">
                        <a href="#" id="emailLinkAnchor" class="email-link" target="_blank">
                            <span class="material-icons">mail</span> Open in Gmail
                        </a>
                    </div>

                </div>
                <div class="dialog-footer">
                    <button type="button" class="btn btn-danger" id="deleteItemBtn" onclick="deleteCurrentItem()"
                        style="display: none;">
                        <span class="material-icons" style="font-size: 18px;">delete</span>
                    </button>
                    <div class="dialog-footer-right">
                        <button type="button" class="btn btn-secondary" onclick="closeItemDialog()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveItem()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="toast" class="toast"></div>
    </div>
    <script>
        var state = { tasks: [], projects: [], contexts: [], areas: [], settings: {}, currentPage: 'inbox', currentTask: null, currentProject: null, selectedIndex: -1, lastKey: null, lastKeyTime: 0 };
        function init(p) {
            state.currentPage = p || 'inbox';
            // setupProjectDropdown(); // Removed as it was replaced by dialog-specific logic
            loadAllData();
        }
        function loadAllData() { showLoading(true); google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onDataError).getAllData(); }
        function onDataLoaded(d) {
            if (!d) { showToast('No data'); showLoading(false); return; } state.tasks = d.tasks || []; state.projects = d.projects || []; state.contexts = d.contexts || []; state.areas = d.areas || []; state.settings = d.settings || {};
            // Inbox Unification: logic removed
            state.inboxId = null;

            // Update Badges
            updateInboxBadge();
            updateNextActionsBadge();
            updateAttentionBadge();

            populateSelects(); navigateTo(state.currentPage); showLoading(false);
        }
        function onDataError(e) { showToast('Error: ' + e); showLoading(false); }
        function populateSelects() {
            var cc = document.getElementById('currentContext');
            if (cc) {
                cc.innerHTML = '<option value="">All Contexts</option>';
                state.contexts.forEach(function (c) {
                    cc.innerHTML += '<option value="' + c.id + '">' + c.icon + ' ' + c.name + '</option>';
                });
            }
            var ce = document.getElementById('currentEnergy');
            if (ce) ce.value = state.settings.currentEnergyLevel || 'medium';

            // Item Dialog Selects
            var tc = document.getElementById('itemContext');
            if (tc) {
                tc.innerHTML = '<option value="">No Context</option>';
                state.contexts.forEach(function (c) {
                    tc.innerHTML += '<option value="' + c.id + '">' + c.icon + ' ' + c.name + '</option>';
                });
            }
            var pa = document.getElementById('itemArea');
            if (pa) {
                pa.innerHTML = '<option value="">No Area</option>';
                state.areas.forEach(function (a) {
                    pa.innerHTML += '<option value="' + a.id + '">' + a.icon + ' ' + a.name + '</option>';
                });
            }
        }
        function navigateTo(p) {
            state.currentPage = p;
            state.selectedIndex = -1; // Reset selection
            document.querySelectorAll('.nav-item').forEach(function (i) { i.classList.remove('active'); if (i.dataset.page === p) i.classList.add('active'); }); var sb = document.getElementById('sidebar'); if (sb) sb.classList.remove('open'); renderPage(p);
        }
        function toggleSidebar() { var sb = document.getElementById('sidebar'); if (sb) sb.classList.toggle('open'); }
        function renderPage(p) { var c = document.getElementById('pageContent'); if (!c) return; var h = ''; if (p === 'inbox') h = renderInbox(); else if (p === 'next') h = renderNext(); else if (p === 'today') h = renderToday(); else if (p === 'scheduled') h = renderScheduled(); else if (p === 'waiting') h = renderWaiting(); else if (p === 'projects') h = renderProjects(); else if (p === 'someday') h = renderSomeday(); else if (p === 'review') h = renderReview(); else if (p === 'contexts') h = renderContexts(); else if (p === 'areas') h = renderAreas(); else if (p === 'attention') h = renderAttention(); else if (p === 'all') h = renderAllTasks(); else if (p === 'search') h = renderSearchResults(); else h = renderInbox(); c.innerHTML = h; }

        // Attention View Logic
        function getAttentionItems() {
            var stalledProjects = [];
            var malformedTasks = [];

            // 1. Stalled Projects: Active projects with no next actions
            // Filter: Must be active AND type='project' (Folders are ignored)
            var activeProjects = state.projects.filter(function (p) {
                return p.status === 'active' && (!p.type || p.type === 'project');
            });
            activeProjects.forEach(function (p) {
                // Check 1: Has incomplete sub-tasks?
                // User Request: Exclude if has "incomplete sub tasks". 
                // Previously only checked 'next'. Now check any status implying incomplete work.
                // Statuses: inbox, next, waiting, scheduled, someday.
                // Exclude: done, deleted, reference(?).
                var projectTasks = state.tasks.filter(function (t) {
                    return (t.projectId === p.id || t.parentTaskId === p.id) &&
                        t.status !== 'done' &&
                        t.status !== 'deleted' &&
                        t.status !== 'reference';
                });

                if (projectTasks.length > 0) return; // Has incomplete tasks (active, waiting, scheduled, etc.), so not stalled

                // Check 2: Has incomplete sub-projects?
                // Previously only checked 'active'. Now check any non-completed/non-dropped.
                var childProjects = state.projects.filter(function (cp) {
                    return cp.parentProjectId === p.id &&
                        cp.status !== 'completed' &&
                        cp.status !== 'dropped';
                });

                if (childProjects.length > 0) return; // Has incomplete sub-projects, so not stalled

                // Check 3: Is scheduled for the future?
                if (p.scheduledDate) {
                    var today = new Date().toISOString().split('T')[0];
                    if (p.scheduledDate > today) return; // Scheduled for future, so not stalled
                }

                // If neither, then it is stalled
                stalledProjects.push(p);
            });

            // 2. Malformed Tasks: Next actions missing context or time
            var nextActions = state.tasks.filter(function (t) { return t.status === 'next'; });
            nextActions.forEach(function (t) {
                var issues = [];
                if (!t.contextId) issues.push('No Context');
                // if (!t.timeEstimate) issues.push('No Time'); // Time is optional? User said "don't have a time estimate"

                // Let's be strict as requested
                // Let's be strict as requested
                if (!t.timeEstimate) issues.push('No Time Est.');
                if (!t.importance) issues.push('No Importance');
                if (!t.urgency) issues.push('No Urgency');

                // Filter: If scheduled date is in the future, ignore
                var isFutureScheduled = false;
                if (t.scheduledDate) {
                    var today = new Date().toISOString().split('T')[0];
                    if (t.scheduledDate > today) isFutureScheduled = true;
                }

                if (issues.length > 0 && !isFutureScheduled) {
                    malformedTasks.push({ task: t, issues: issues });
                }
            });

            return { stalledProjects: stalledProjects, malformedTasks: malformedTasks };
        }

        function updateAttentionBadge() {
            var data = getAttentionItems();
            var count = data.stalledProjects.length + data.malformedTasks.length;
            var b = document.getElementById('attentionBadge');
            if (b) b.textContent = count > 0 ? count : '';
        }

        function renderAttention() {
            var data = getAttentionItems();
            var h = '<div class="page-header"><h2>Attention</h2><p>Items requiring maintenance</p></div>';

            if (data.stalledProjects.length === 0 && data.malformedTasks.length === 0) {
                h += '<div class="empty-state"><span class="material-icons" style="color: var(--success)">check_circle</span><h3>All Systems Go!</h3><p>Your system is clean and up to date.</p></div>';
                return h;
            }

            // Stalled Projects
            if (data.stalledProjects.length > 0) {
                h += '<div class="review-section"><h3><span class="material-icons" style="color: var(--warning)">warning</span> Stalled Projects (' + data.stalledProjects.length + ')</h3>';
                h += '<p>Active projects with no Next Actions defined. Fix or defer them below.</p>';
                h += '<div class="task-list" id="attentionProjectFixList">';
                data.stalledProjects.forEach(function (p) {
                    h += '<div class="project-card fix-item" data-id="' + p.id + '" onclick="openItemDialog(\'' + p.id + '\')" style="border-left-color: var(--warning);">';
                    h += '<div style="flex: 1; font-weight: 600;">' + esc(p.name) + '</div>';

                    // Bulk Action Controls
                    h += '<div style="display:flex; align-items:center;">';

                    // Scheduled Date
                    h += '<span style="font-size:10px; color:var(--text-muted); margin-right:4px;">Sched:</span>';
                    h += '<input type="date" class="form-control fix-scheduled" value="' + (p.scheduledDate || '') + '" style="width:115px; padding:3px; font-size:12px; margin-right:8px;" onclick="event.stopPropagation()">';

                    // Due Date
                    h += '<span style="font-size:10px; color:var(--text-muted); margin-right:4px;">Due:</span>';
                    h += '<input type="date" class="form-control fix-due" value="' + (p.dueDate || '') + '" style="width:115px; padding:3px; font-size:12px; margin-right:8px;" onclick="event.stopPropagation()">';

                    h += '<select class="form-control fix-status" style="width:110px; padding:4px; font-size:12px; margin-right:8px;" onclick="event.stopPropagation()">';
                    h += '<option value="">Status...</option>'; // No change
                    h += '<option value="someday">Someday</option>';
                    h += '<option value="completed">Completed</option>';
                    h += '<option value="dropped">Dropped</option>';
                    h += '<option value="deleted">Delete</option>';
                    h += '</select>';
                    h += '</div>';

                    h += '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openItemDialog(null, \'task\', \'' + p.id + '\')">Add Action</button>';
                    h += '</div>';
                });
                h += '</div>';
                h += '<button class="add-btn" onclick="saveProjectAttentionFixes()" style="margin-top:16px; justify-content:center; background:var(--primary); color:white; border:none;"><span class="material-icons">save</span> Save Project Fixes</button>';
                h += '</div>';
            }

            // Malformed Tasks
            if (data.malformedTasks.length > 0) {
                h += '<div class="review-section"><h3><span class="material-icons" style="color: var(--danger)">error</span> Task Hygiene (' + data.malformedTasks.length + ')</h3>';
                h += '<p>Next Actions missing context or time estimates. Fix them below and click Save.</p>';
                h += '<div class="task-list" id="attentionFixList">';

                data.malformedTasks.forEach(function (item) {
                    var t = item.task;
                    var issues = item.issues;
                    var isContextMissing = issues.indexOf('No Context') !== -1;
                    var isTimeMissing = issues.indexOf('No Time Est.') !== -1;

                    h += '<div class="task-item fix-item" data-id="' + t.id + '" onclick="openItemDialog(\'' + t.id + '\')">';
                    h += '<div class="task-content">';
                    h += '<div class="task-title">' + esc(t.title) + '</div>';

                    h += '<div class="task-meta" style="display:flex; gap:8px; align-items:center; margin-top:6px;">';

                    // Type Selector (Always show)
                    h += '<select class="form-control fix-type" style="width:90px; padding:4px; font-size:12px; margin-right:8px;" onclick="event.stopPropagation()">';
                    h += '<option value="task" ' + (t.type === 'task' || !t.type ? 'selected' : '') + '>Task</option>';
                    h += '<option value="project" ' + (t.type === 'project' ? 'selected' : '') + '>Project</option>';
                    h += '<option value="folder" ' + (t.type === 'folder' ? 'selected' : '') + '>Folder</option>';
                    h += '</select>';

                    if (isContextMissing) {
                        h += '<select class="form-control fix-context" style="width:140px; padding:4px; font-size:12px;" onclick="event.stopPropagation()">';
                        h += '<option value="">Select Context...</option>';
                        state.contexts.forEach(function (c) {
                            h += '<option value="' + c.id + '">' + c.icon + ' ' + c.name + '</option>';
                        });
                        h += '</select>';
                    }

                    if (isTimeMissing) {
                        h += '<input type="number" class="fix-time" placeholder="Mins" style="width:70px; padding:4px; font-size:12px; border:1px solid var(--border-color); border-radius:4px;" onclick="event.stopPropagation()">';
                    }

                    // Status Dropdown
                    h += '<select class="form-control fix-status" style="width:90px; padding:4px; font-size:12px;" onclick="event.stopPropagation()">';
                    h += '<option value="">Status...</option>'; // No change
                    h += '<option value="next">Next</option>';
                    h += '<option value="done">Done</option>';
                    h += '<option value="waiting">Waiting</option>';
                    h += '<option value="someday">Someday</option>';
                    h += '<option value="deleted">Delete</option>';
                    h += '</select>';

                    // Importance (Condition: Missing or just always show in fix mode?)
                    // Show if missing
                    if (item.issues.indexOf('No Importance') !== -1) {
                        h += '<select class="form-control fix-importance" style="width:70px; padding:4px; font-size:12px; border-color:var(--danger);" onclick="event.stopPropagation()">';
                        h += '<option value="">Imp...</option>';
                        ['1', '2', '3', '4'].forEach(v => {
                            var l = { 1: 'Low', 2: 'Nrm', 3: 'Hi', 4: 'Top' }[v];
                            h += '<option value="' + v + '">' + l + '</option>';
                        });
                        h += '</select>';
                    }

                    // Urgency
                    if (item.issues.indexOf('No Urgency') !== -1) {
                        h += '<select class="form-control fix-urgency" style="width:70px; padding:4px; font-size:12px; border-color:var(--danger);" onclick="event.stopPropagation()">';
                        h += '<option value="">Urg...</option>';
                        ['1', '2', '3', '4'].forEach(v => {
                            var l = { 1: 'Low', 2: 'Nrm', 3: 'Hi', 4: 'Crt' }[v];
                            h += '<option value="' + v + '">' + l + '</option>';
                        });
                        h += '</select>';
                    }

                    // Scheduled (Always show to allow deferring)
                    h += '<span style="font-size:10px; color:var(--text-muted); margin-left:8px; margin-right:2px;">Sched:</span>';
                    h += '<input type="date" class="form-control fix-scheduled" value="' + (t.scheduledDate || '') + '" style="width:110px; padding:3px; font-size:12px;" onclick="event.stopPropagation()">';

                    // Due (Always show)
                    h += '<span style="font-size:10px; color:var(--text-muted); margin-left:8px; margin-right:2px;">Due:</span>';
                    h += '<input type="date" class="form-control fix-due" value="' + (t.dueDate || '') + '" style="width:110px; padding:3px; font-size:12px;" onclick="event.stopPropagation()">';

                    h += '</div></div></div>';
                });
                h += '</div>';
                h += '<button class="add-btn" onclick="saveAttentionFixes()" style="margin-top:16px; justify-content:center; background:var(--primary); color:white; border:none;"><span class="material-icons">save</span> Save All Fixes</button>';
                h += '</div>';
            }

            return h;
        }

        // Search Logic
        var searchTimeout;
        function handleSearch(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function () {
                var query = e.target.value.trim().toLowerCase();
                if (query.length > 0) {
                    state.searchQuery = query;
                    navigateTo('search');
                } else {
                    state.searchQuery = '';
                    if (state.currentPage === 'search') navigateTo('inbox');
                }
            }, 300); // Debounce
        }

        function renderSearchResults() {
            var q = state.searchQuery;
            if (!q) return '<div class="page-header"><h2>Search</h2><p>Type to search...</p></div>';

            var h = '<div class="page-header"><h2>Search Results</h2><p>Matches for "' + esc(q) + '"</p></div>';

            // Build full tree
            var roots = buildUnifiedTree(state.tasks, state.projects);

            // Filter tree
            var filteredRoots = filterTree(roots, q);

            if (filteredRoots.length === 0) {
                h += '<div class="empty-state"><span class="material-icons">search_off</span><h3>No matches found</h3></div>';
            } else {
                h += '<div class="task-list">';
                h += renderUnifiedTree(filteredRoots, 0);
                h += '</div>';
            }
            return h;
        }

        function filterTree(nodes, query) {
            var res = [];
            nodes.forEach(function (node) {
                var match = false;
                if (node.type === 'project') {
                    match = (node.data.name && node.data.name.toLowerCase().includes(query)) ||
                        (node.data.description && node.data.description.toLowerCase().includes(query));
                } else {
                    match = (node.data.title && node.data.title.toLowerCase().includes(query)) ||
                        (node.data.notes && node.data.notes.toLowerCase().includes(query));
                }

                if (match) {
                    // If match, keep node and ALL children
                    res.push(node);
                } else {
                    // If no match, check children
                    var filteredChildren = filterTree(node.children, query);
                    if (filteredChildren.length > 0) {
                        // Create a shallow copy to avoid mutating the original node's children if referenced elsewhere
                        // (Though buildUnifiedTree returns fresh nodes, so mutation is safe-ish, but copy is cleaner)
                        var newNode = Object.assign({}, node);
                        newNode.children = filteredChildren;
                        res.push(newNode);
                    }
                }
            });
            return res;
        }

        // Keyboard Shortcuts System
        document.addEventListener('keydown', handleKeyboard);

        function handleKeyboard(e) {
            // Ignore if typing in input/textarea (except Esc which might blur)
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Escape') e.target.blur();
                return;
            }

            // Global Shortcuts
            const now = Date.now();

            // 'g' key sequence handler
            if (state.lastKey === 'g' && (now - state.lastKeyTime < 1000)) {
                state.lastKey = null; // Reset
                if (e.key === 'i') { navigateTo('inbox'); return; }
                if (e.key === 'n') { navigateTo('next'); return; }
                if (e.key === 'p') { navigateTo('projects'); return; }
                if (e.key === 's') { navigateTo('someday'); return; }
                if (e.key === 'w') { navigateTo('waiting'); return; }
            }

            if (e.key === 'g') {
                state.lastKey = 'g';
                state.lastKeyTime = now;
                return;
            }

            // Normal Shortcuts
            if (e.key === '/') {
                e.preventDefault();
                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.focus();
                return;
            }

            if (e.key === 'c') {
                e.preventDefault();
                const captureInput = document.getElementById('quickCaptureInput');
                if (captureInput) captureInput.focus();
                return;
            }

            if (e.key === '?') {
                alert('Keyboard Shortcuts:\n\nNavigation:\nj / Down: Next Item\nk / Up: Prev Item\nEnter: Open Item\n\nActions:\nx: Toggle Checkbox\n#: Delete\nc: Quick Capture\n/: Search\n\nGo To:\ng then i: Inbox\ng then n: Next Actions\ng then p: Projects');
                return;
            }

            // List Navigation (j/k)
            const items = getVisibleItems();
            if (items.length === 0) return;

            if (e.key === 'j' || e.key === 'ArrowDown') {
                state.selectedIndex++;
                if (state.selectedIndex >= items.length) state.selectedIndex = 0;
                highlightItem(items[state.selectedIndex]);
                return;
            }

            if (e.key === 'k' || e.key === 'ArrowUp') {
                state.selectedIndex--;
                if (state.selectedIndex < 0) state.selectedIndex = items.length - 1;
                highlightItem(items[state.selectedIndex]);
                return;
            }

            if (e.key === 'Enter' || e.key === 'o') {
                if (state.selectedIndex >= 0 && state.selectedIndex < items.length) {
                    // Click the item to open it
                    items[state.selectedIndex].click();
                }
                return;
            }

            if (e.key === 'x') {
                // Toggle Checkbox logic
                // Needs us to find the checkbox inside the selected item and click it
                if (state.selectedIndex >= 0 && state.selectedIndex < items.length) {
                    const checkbox = items[state.selectedIndex].querySelector('.task-checkbox');
                    if (checkbox) checkbox.click();
                }
                return;
            }

            if (e.key === '#') {
                // Delete
                if (state.selectedIndex >= 0 && state.selectedIndex < items.length) {
                    // Simulate open dialog and delete? 
                    // Or direct API call?
                    // Logic was: openTaskDialog -> delete
                    // Let's open the dialog first
                    items[state.selectedIndex].click();
                    // Then triggering delete is messy.
                    // The user previously implemented this by opening the dialog.
                    // "Action handlers ... #: delete"
                    // Let's just open the dialog for now, or if open, delete?
                    // If dialog is open, we can listen for # there?
                    // If list view, maybe we should just open dialog.
                }
                return;
            }

            if (e.key === 'Escape') {
                closeItemDialog();
                // closeContextDialog(); // No longer exists
                // closeAreaDialog(); // No longer exists
                // closeSearch?
                return;
            }
        }

        function getVisibleItems() {
            // Select both tasks and projects
            return Array.from(document.querySelectorAll('.task-item, .project-card'));
        }

        function highlightItem(item) {
            // Remove previous selection
            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));

            // Apply new selection
            if (item) {
                item.classList.add('selected');
                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function getInboxTasks() {
            // Unified Inbox: Strictly items with status 'inbox'
            return state.tasks.filter(function (x) {
                return x.status === 'inbox' && x.status !== 'deleted' && x.status !== 'done';
            });
        }

        // Helper to get parent name
        function getParentProjectName(id) {
            if (!id) return '';
            var p = state.projects.find(function (x) { return x.id === id; });
            return p ? p.name : '';
        }

        function renderInbox() {
            var t = getInboxTasks();
            var h = '<div class="page-header"><h2>Inbox</h2><p>Capture everything, process later</p></div>';
            // Add Import Button
            h += '<div style="margin-bottom: 16px;">' +
                '<button class="btn btn-secondary" onclick="importGmail()" style="margin-right: 8px;"><span class="material-icons">download</span> Import (GTD/ToProcess)</button>' +
                '<button class="btn btn-secondary" onclick="scanInbox()" style="margin-right: 8px;"><span class="material-icons">psychology</span> Scan Inbox (AI)</button>' +
                '</div>';

            if (t.length === 0) {
                h += '<div class="empty-state"><span class="material-icons">inbox</span><h3>Inbox Zero!</h3><p>Everything processed.</p></div>';
            } else {
                h += '<div class="task-list" id="inboxList">';
                t.forEach(function (x) { h += renderInboxBulkRow(x); });
                h += '</div>';
                h += '<button class="add-btn" onclick="saveInboxUpdates()" style="margin-top:16px; justify-content:center; background:var(--primary); color:white; border:none;"><span class="material-icons">save</span> Process Inbox</button>';
            }
            return h;
        }

        function renderInboxBulkRow(t) {
            // Layout: 3 Rows
            // Row 1: Star | Title | Status
            // Row 2: Type | Project | Context | Importance | Urgency
            // Row 3: Due | Scheduled | Time | Energy

            var h = '<div class="task-item fix-item" data-id="' + t.id + '" style="flex-direction:column; align-items:stretch; gap:8px; cursor:default; padding:12px;">';

            // --- Row 1: Star | Title | Status ---
            h += '<div style="display:flex; align-items:center; gap:8px;">';
            // Star
            var starIcon = t.isStarred ? 'star' : 'star_border';
            var starColor = t.isStarred ? '#f59e0b' : 'var(--text-muted)';
            h += '<span class="material-icons fix-star" onclick="event.stopPropagation(); toggleBulkStar(this)" style="cursor:pointer; color:' + starColor + '; font-size:20px;" data-starred="' + (t.isStarred || 'false') + '">' + starIcon + '</span>';
            // Title
            h += '<div class="task-title" onclick="openItemDialog(\'' + t.id + '\')" style="cursor:pointer; font-weight:600; color:var(--primary); flex:1; font-size:14px;">' + esc(t.title) + '</div>';
            // Status (Moved to Top Row)
            h += '<select class="form-control fix-status" style="width:110px; padding:4px; font-size:12px;" onclick="event.stopPropagation()">';
            var statuses = ['inbox', 'next', 'waiting', 'scheduled', 'someday', 'done', 'deleted'];
            statuses.forEach(function (s) {
                var sel = (t.status === s) ? 'selected' : '';
                h += '<option value="' + s + '" ' + sel + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>';
            });
            h += '</select>';
            h += '</div>';

            // --- Row 2: Type | Project | Context | Importance | Urgency ---
            h += '<div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">';

            // Type
            h += '<select class="form-control fix-type" style="width:90px; padding:4px; font-size:12px;" onclick="event.stopPropagation()">';
            h += '<option value="task" ' + (t.type === 'task' || !t.type ? 'selected' : '') + '>Task</option>';
            h += '<option value="project" ' + (t.type === 'project' ? 'selected' : '') + '>Project</option>';
            h += '<option value="folder" ' + (t.type === 'folder' ? 'selected' : '') + '>Folder</option>';
            h += '</select>';

            // Project
            h += '<div style="flex:1; min-width:120px; position:relative;">';
            h += '<input type="text" class="form-control fix-project-display" placeholder="Select Project..." value="' + esc(getParentProjectName(t.projectId)) + '" onfocus="showInlineProjectDropdown(this)" oninput="filterInlineProjectDropdown(this)" onclick="event.stopPropagation()" style="width:100%; padding:4px; font-size:12px;">';
            h += '<input type="hidden" class="fix-project" value="' + (t.projectId || '') + '">';
            h += '<div class="fix-project-dropdown" style="display:none; position:absolute; top:100%; left:0; right:0; max-height:200px; overflow-y:auto; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:4px; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>';
            h += '</div>';

            // Context
            h += '<select class="form-control fix-context" style="width:110px; padding:4px; font-size:12px;" onclick="event.stopPropagation()">';
            h += '<option value="">Context...</option>';
            state.contexts.forEach(function (c) {
                var sel = (t.contextId === c.id) ? 'selected' : '';
                h += '<option value="' + c.id + '" ' + sel + '>' + c.icon + ' ' + c.name + '</option>';
            });
            h += '</select>';

            // Importance (With Placeholder)
            h += '<div style="display:flex; align-items:center; gap:4px;">';
            h += '<span style="font-size:11px; color:var(--text-muted)">Imp:</span>';
            h += '<select class="form-control fix-importance" style="width:70px; padding:4px; font-size:12px;" onclick="event.stopPropagation()">';
            h += '<option value="">Select...</option>';
            ['1', '2', '3', '4'].forEach(v => {
                var l = { 1: 'Low', 2: 'Nrm', 3: 'Hi', 4: 'Top' }[v];
                var sel = (t.importance == v) ? 'selected' : '';
                h += '<option value="' + v + '" ' + sel + '>' + l + '</option>';
            });
            h += '</select>';
            h += '</div>';

            // Urgency (With Placeholder)
            h += '<div style="display:flex; align-items:center; gap:4px;">';
            h += '<span style="font-size:11px; color:var(--text-muted)">Urg:</span>';
            h += '<select class="form-control fix-urgency" style="width:70px; padding:4px; font-size:12px;" onclick="event.stopPropagation()">';
            h += '<option value="">Select...</option>';
            ['1', '2', '3', '4'].forEach(v => {
                var l = { 1: 'Low', 2: 'Nrm', 3: 'Hi', 4: 'Crt' }[v];
                var sel = (t.urgency == v) ? 'selected' : '';
                h += '<option value="' + v + '" ' + sel + '>' + l + '</option>';
            });
            h += '</select>';
            h += '</div>';

            h += '</div>'; // End Row 2

            // --- Row 3: Dates & Details ---
            h += '<div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">';

            // Due Date
            h += '<div style="display:flex; align-items:center; gap:4px;">';
            h += '<span style="font-size:11px; color:var(--text-muted)">Due:</span>';
            h += '<input type="date" class="form-control fix-due" value="' + (t.dueDate || '') + '" style="width:120px; padding:3px; font-size:12px;" onclick="event.stopPropagation()">';
            h += '</div>';

            // Scheduled
            h += '<div style="display:flex; align-items:center; gap:4px;">';
            h += '<span style="font-size:11px; color:var(--text-muted)">Sched:</span>';
            h += '<input type="date" class="form-control fix-scheduled" value="' + (t.scheduledDate || '') + '" style="width:120px; padding:3px; font-size:12px;" onclick="event.stopPropagation()">';
            h += '</div>';

            // Time
            h += '<div style="display:flex; align-items:center; gap:4px;">';
            h += '<span style="font-size:11px; color:var(--text-muted)">Time:</span>';
            h += '<input type="number" class="fix-time" placeholder="Min" value="' + (t.timeEstimate || '') + '" style="width:60px; padding:4px; font-size:12px; border:1px solid var(--border-color); border-radius:4px;" onclick="event.stopPropagation()">';
            h += '</div>';

            // Energy
            h += '<div style="display:flex; align-items:center; gap:4px;">';
            h += '<span style="font-size:11px; color:var(--text-muted)">Energy:</span>';
            h += '<select class="form-control fix-energy" style="width:80px; padding:4px; font-size:12px;" onclick="event.stopPropagation()">';
            h += '<option value="medium" ' + (t.energyRequired === 'medium' ? 'selected' : '') + '> Med</option>';
            h += '<option value="high" ' + (t.energyRequired === 'high' ? 'selected' : '') + '> High</option>';
            h += '<option value="low" ' + (t.energyRequired === 'low' ? 'selected' : '') + '> Low</option>';
            h += '</select>';
            h += '</div>';

            h += '</div>'; // End Row 3

            h += '</div>'; // End Container
            return h;
        }

        // Inline Project Dropdown Logic
        function showInlineProjectDropdown(input) {
            // Close others?
            document.querySelectorAll('.fix-project-dropdown').forEach(d => {
                d.style.display = 'none';
                d.closest('.fix-item').style.zIndex = '';
                d.closest('.fix-item').style.position = '';
            });

            var container = input.parentElement;
            var dropdown = container.querySelector('.fix-project-dropdown');
            dropdown.style.display = 'block';

            // Raise z-index of the row
            var row = container.closest('.fix-item');
            if (row) {
                row.style.position = 'relative';
                row.style.zIndex = '1000';
            }

            renderInlineProjectDropdown(dropdown, state.projects, input.value);

            // Global click to close
            document.addEventListener('click', function close(e) {
                if (!container.contains(e.target)) {
                    dropdown.style.display = 'none';
                    if (row) {
                        row.style.zIndex = '';
                        row.style.position = '';
                    }
                    document.removeEventListener('click', close);
                }
            });
        }

        function filterInlineProjectDropdown(input) {
            var container = input.parentElement;
            var dropdown = container.querySelector('.fix-project-dropdown');
            renderInlineProjectDropdown(dropdown, state.projects, input.value);
        }

        // Helper to build a hierarchical project tree
        function buildProjectTree(projects) {
            var projectMap = {};
            var roots = [];

            projects.forEach(function (p) {
                projectMap[p.id] = { project: p, children: [] };
            });

            projects.forEach(function (p) {
                if (p.parentProjectId && projectMap[p.parentProjectId]) {
                    projectMap[p.parentProjectId].children.push(projectMap[p.id]);
                } else {
                    roots.push(projectMap[p.id]);
                }
            });

            // Sort children by name
            function sortTree(nodes) {
                nodes.sort((a, b) => a.project.name.localeCompare(b.project.name));
                nodes.forEach(node => sortTree(node.children));
            }
            sortTree(roots);

            return roots;
        }

        function renderInlineProjectDropdown(container, projects, filter) {
            var h = '';
            var matches = [];

            var tree = buildProjectTree(state.projects.filter(p => p.status === 'active'));

            function traverseTree(nodes, depth) {
                nodes.forEach(function (node) {
                    var p = node.project;
                    var match = !filter || p.name.toLowerCase().includes(filter.toLowerCase());
                    if (match) {
                        matches.push({ item: p, depth: depth });
                    }
                    traverseTree(node.children, depth + 1);
                });
            }
            traverseTree(tree, 0);

            if (matches.length === 0) {
                h = '<div style="padding:8px; color:var(--text-muted); font-size:12px;">No projects found</div>';
            } else {
                h += '<div class="dropdown-item" onclick="selectInlineProject(this, \'\', \'No Project\')" style="padding:6px 12px; cursor:pointer; font-size:12px;">No Project</div>';
                matches.forEach(function (m) {
                    var p = m.item;
                    var pad = m.depth * 12; // Indent
                    h += '<div class="dropdown-item" onclick="selectInlineProject(this, \'' + p.id + '\', \'' + esc(p.name).replace(/'/g, "\\'") + '\')" style="padding:6px 12px 6px ' + (12 + pad) + 'px; cursor:pointer; font-size:12px;">';
                    if (p.type === 'folder') h += '<span class="material-icons" style="font-size:14px; vertical-align:middle; margin-right:4px;">folder</span>';
                    else h += '<span class="material-icons" style="font-size:14px; vertical-align:middle; margin-right:4px;">assignment</span>';
                    h += esc(p.name) + '</div>';
                });
            }
            container.innerHTML = h;
        }

        function selectInlineProject(el, id, name) {
            var container = el.closest('.fix-item').querySelector('.fix-project').parentElement; // div container
            var display = container.querySelector('.fix-project-display');
            var hidden = container.querySelector('.fix-project');
            var dropdown = container.querySelector('.fix-project-dropdown');
            var row = el.closest('.fix-item');

            display.value = name;
            hidden.value = id;
            dropdown.style.display = 'none';
            if (row) {
                row.style.zIndex = '';
                row.style.position = '';
            }
        }

        function updateInboxBadge() {
            var c = getInboxTasks().length;
            var b = document.getElementById('inboxBadge');
            if (b) b.textContent = c > 0 ? c : '';
        }

        function updateNextActionsBadge() {
            try {
                const debugDiv = document.getElementById('debug-info');
                if (debugDiv) debugDiv.textContent = 'Running updateNextActionsBadge...';

                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                const nextTasks = state.tasks.filter(t => t.status === 'next');

                const count = nextTasks.filter(t => {
                    if (!t.dueDate) return false;
                    try {
                        // Handle YYYY-MM-DD string
                        if (typeof t.dueDate === 'string' && t.dueDate.includes('-')) {
                            const parts = t.dueDate.split('-');
                            const due = new Date(parts[0], parts[1] - 1, parts[2]);
                            return due <= today;
                        }
                        // Handle other formats (fallback)
                        const d = new Date(t.dueDate);
                        if (!isNaN(d.getTime())) {
                            d.setHours(0, 0, 0, 0);
                            return d <= today;
                        }
                    } catch (e) {
                        console.error('Date parse error', e);
                    }
                    return false;
                }).length;

                const b = document.getElementById('nextActionsBadge');
                if (b) {
                    b.textContent = count > 0 ? count : '';
                }

                // DEBUG: On-page display
                if (debugDiv) {
                    const firstTask = nextTasks.length > 0 ? nextTasks[0] : null;
                    debugDiv.innerHTML = `<strong>Debug Info:</strong><br>` +
                        `Badge Count: ${count}<br>` +
                        `Total Tasks: ${state.tasks.length}<br>` +
                        `Next Tasks: ${nextTasks.length}<br>` +
                        `Due Tasks: ${state.tasks.filter(t => t.dueDate).length}<br>` +
                        `First Next Task: ${firstTask ? JSON.stringify(firstTask) : 'None'}<br>` +
                        `Today: ${today.toDateString()}`;
                }
            } catch (err) {
                const debugDiv = document.getElementById('debug-info');
                if (debugDiv) debugDiv.textContent = 'Error: ' + err.toString();
            }
        }

        function renderAllTasks() {
            var tree = buildUnifiedTree(state.tasks, state.projects);
            var h = '<div class="page-header"><h2>All Tasks</h2><p>Unified Hierarchical View</p></div>';
            h += '<div class="task-list">';
            h += renderUnifiedTree(tree, 0);
            h += '</div>';
            return h;
        }

        function buildUnifiedTree(tasks, projects) {
            var map = {};
            var roots = [];

            // Initialize map with Projects
            projects.forEach(function (p) {
                if (p.status !== 'active') return;
                map[p.id] = { data: p, type: p.type || 'project', children: [] };
            });

            // Initialize map with Tasks
            tasks.forEach(function (t) {
                // Unified View: Exclude 'inbox', 'deleted', 'done'
                if (t.status === 'deleted' || t.status === 'done' || t.status === 'inbox') return;
                map[t.id] = { data: t, type: 'task', children: [] };
            });

            // Build hierarchy
            // 1. Link Projects to Parent Projects
            projects.forEach(function (p) {
                if (p.status !== 'active') return;
                var node = map[p.id];
                if (p.parentProjectId && map[p.parentProjectId]) {
                    map[p.parentProjectId].children.push(node);
                } else {
                    roots.push(node);
                }
            });

            // 2. Link Tasks to Parents (Task or Project)
            tasks.forEach(function (t) {
                if (t.status === 'deleted' || t.status === 'done' || t.status === 'inbox') return;
                var node = map[t.id];

                // Priority: Parent Task > Project
                var parentId = t.parentTaskId || t.projectId;

                if (parentId && map[parentId]) {
                    map[parentId].children.push(node);
                } else {
                    // If task has no parent task and no project (or parent not found), it's a root
                    roots.push(node);
                }
            });

            // Sort
            var sorter = function (a, b) {
                var orderA = a.data.sortOrder || 0;
                var orderB = b.data.sortOrder || 0;
                return orderA - orderB;
            };

            roots.sort(sorter);
            Object.values(map).forEach(function (node) {
                node.children.sort(sorter);
            });

            return roots;
        }

        function renderUnifiedTree(nodes, level) {
            var h = '';
            nodes.forEach(function (node) {
                var padding = level * 24;
                // Combine styles into one string
                var commonStyle = 'margin-left: ' + padding + 'px; margin-bottom: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;';

                if (node.type === 'project' || node.type === 'folder') {
                    // Render Project/Folder
                    var p = node.data;
                    var icon = p.type === 'folder' ? 'folder_open' : 'folder';
                    h += '<div class="project-card" onclick="openItemDialog(\'' + p.id + '\')" style="' + commonStyle + '">';
                    h += '<div class="task-checkbox" onclick="event.stopPropagation();completeProjectClick(\'' + p.id + '\')"></div>';
                    h += '<div style="flex: 1; font-weight: 600; font-size: 14px; color: var(--text-primary); display: flex; align-items: center;"><span class="material-icons" style="font-size: 18px; margin-right: 6px; color: var(--text-muted);">' + icon + '</span>' + esc(p.name) + '</div>';
                    h += '</div>';
                } else {
                    // Render Task
                    var t = node.data;
                    // For tasks, we use padding-left on the item if it's in a list, but here we are mixing.
                    // Let's use a wrapper or just style the item.
                    // Existing taskItem uses flex. We can add a margin-left style.

                    var ctx = state.contexts.find(function (c) { return c.id === t.contextId; });
                    var prj = state.projects.find(function (p) { return p.id === t.projectId; });

                    h += '<div class="task-item" style="margin-left: ' + padding + 'px" onclick="openItemDialog(\'' + t.id + '\')">';
                    h += '<div class="task-checkbox" onclick="event.stopPropagation();completeTaskClick(\'' + t.id + '\')"></div>';
                    h += '<div class="task-content">';
                    h += '<div class="task-title">' + esc(t.title) + '</div>';

                    var m = [];
                    if (ctx) m.push(ctx.icon + ' ' + ctx.name);
                    // Don't show project name in meta if we are nested under it?
                    // Actually, "All Tasks" might show it for context if flat, but in tree it's redundant if nested.
                    // But logic is complex to know if parent is the project.
                    // Let's keep it simple for now.
                    if (t.dueDate) m.push(t.dueDate);
                    if (m.length > 0) h += '<div class="task-meta">' + m.join(' &bull; ') + '</div>';

                    h += '</div></div>';
                }

                if (node.children.length > 0) {
                    h += renderUnifiedTree(node.children, level + 1);
                }
            });
            return h;
        }

        function calculateTaskScore(task) {
            let score = 0;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // --- 1. Star / Focus (Top Priority) ---
            if (task.isStarred) score += 5000;

            // --- 2. MLO Core: Importance * Urgency ---
            // Default to 2 (Normal) if unset
            let imp = task.importance ? parseFloat(task.importance) : 2;
            let urg = task.urgency ? parseFloat(task.urgency) : 2;

            // --- 3. Due Date Amplifier (Increases Urgency) ---
            if (task.dueDate) {
                const parts = task.dueDate.split('-');
                const due = new Date(parts[0], parts[1] - 1, parts[2]);
                const diffTime = due - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) urg *= 4;      // Overdue (4x Urgency)
                else if (diffDays === 0) urg *= 3; // Today (3x Urgency)
                else if (diffDays === 1) urg *= 2; // Tomorrow (2x Urgency)
                else if (diffDays <= 7) urg *= 1.5; // This Week (1.5x)
            }

            // Add Base Score
            score += (imp * 10) * (urg * 10);

            // --- 4. Effort / Energy (Tie Breaker: Least Effort First) ---
            // Low Energy > Medium > High
            if (task.energyRequired === 'low') score += 50;
            else if (task.energyRequired === 'medium') score += 20;

            // --- 5. Time Estimate (Tie Breaker: Quickest First) ---
            if (task.timeEstimate) {
                // Invert: 5 mins = +50, 60 mins = +0
                // Cap at 120 mins
                let mins = parseInt(task.timeEstimate);
                if (mins > 0 && mins < 120) {
                    score += (120 - mins) * 0.5;
                }
            }


            return score;
        }

        function renderNext() {
            var now = new Date();
            var today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

            var t = state.tasks.filter(function (x) {
                var isFuture = x.scheduledDate && x.scheduledDate > today;
                return x.status === 'next' && !isFuture;
            });

            // Sort by Score Descending
            t.sort(function (a, b) {
                return calculateTaskScore(b) - calculateTaskScore(a);
            });

            var h = '<div class="page-header"><h2>Next Actions</h2><p>Things ready to do now</p></div>';
            if (t.length === 0) h += '<div class="empty-state"><span class="material-icons">check_circle</span><h3>No Next Actions</h3></div>';
            else { h += '<div class="task-list">'; t.forEach(function (x) { h += taskItem(x); }); h += '</div>'; }
            return h;
        }
        function renderToday() { var td = new Date().toISOString().split('T')[0]; var t = state.tasks.filter(function (x) { return (x.dueDate === td || x.scheduledDate === td) && x.status !== 'done' && x.status !== 'deleted'; }); var h = '<div class="page-header"><h2>Today</h2><p>' + new Date().toLocaleDateString() + '</p></div>'; if (t.length === 0) h += '<div class="empty-state"><span class="material-icons">event_available</span><h3>Clear Day</h3></div>'; else { h += '<div class="task-list">'; t.forEach(function (x) { h += taskItem(x); }); h += '</div>'; } return h; }
        function renderScheduled() { var t = state.tasks.filter(function (x) { return x.status === 'scheduled'; }); var h = '<div class="page-header"><h2>Scheduled</h2><p>Tasks for specific dates</p></div>'; if (t.length === 0) h += '<div class="empty-state"><span class="material-icons">event</span><h3>Nothing Scheduled</h3></div>'; else { h += '<div class="task-list">'; t.forEach(function (x) { h += taskItem(x); }); h += '</div>'; } return h; }
        function renderWaiting() { var t = state.tasks.filter(function (x) { return x.status === 'waiting'; }); var h = '<div class="page-header"><h2>Waiting For</h2><p>Delegated items</p></div>'; if (t.length === 0) h += '<div class="empty-state"><span class="material-icons">hourglass_empty</span><h3>Not Waiting</h3></div>'; else { h += '<div class="task-list">'; t.forEach(function (x) { h += taskItem(x); }); h += '</div>'; } return h; }
        function renderProjects() {
            var projects = state.projects.filter(function (x) { return x.status === 'active'; });
            var tree = buildProjectTree(projects);
            var h = '<div class="page-header"><h2>Projects</h2><p>Multi-step outcomes</p></div>';
            h += '<button class="btn btn-primary" onclick="openItemDialog(null, \'project\')" style="margin-bottom:16px"><span class="material-icons">add</span> New Project</button>';

            if (projects.length === 0) {
                h += '<div class="empty-state"><span class="material-icons">folder_open</span><h3>No Active Projects</h3></div>';
            } else {
                h += renderProjectTree(tree, 0);
            }
            return h;
        }

        function buildProjectTree(projects) {
            var map = {};
            var roots = [];

            // Initialize map
            projects.forEach(function (p) {
                map[p.id] = { project: p, children: [] };
            });

            // Build hierarchy
            projects.forEach(function (p) {
                if (p.parentProjectId && map[p.parentProjectId]) {
                    map[p.parentProjectId].children.push(map[p.id]);
                } else {
                    roots.push(map[p.id]);
                }
            });

            // Sort roots and children by sortOrder
            var sorter = function (a, b) { return (a.project.sortOrder || 0) - (b.project.sortOrder || 0); };
            roots.sort(sorter);
            Object.values(map).forEach(function (node) {
                node.children.sort(sorter);
            });

            return roots;
        }

        function renderProjectTree(nodes, level) {
            var h = '';
            nodes.forEach(function (node) {
                var x = node.project;
                var tc = state.tasks.filter(function (t) { return t.projectId === x.id && t.status !== 'done' && t.status !== 'deleted'; }).length;
                var padding = level * 24;

                var style = 'margin-left: ' + padding + 'px; margin-bottom: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;';
                var icon = x.type === 'folder' ? 'folder_open' : 'folder';

                h += '<div class="project-card" onclick="openItemDialog(\'' + x.id + '\')" style="' + style + '">';
                h += '<div class="task-checkbox" onclick="event.stopPropagation();completeProjectClick(\'' + x.id + '\')"></div>';
                h += '<div style="flex: 1; font-weight: 600; font-size: 14px; color: var(--text-primary); display: flex; align-items: center;"><span class="material-icons" style="font-size: 18px; margin-right: 6px; color: var(--text-muted);">' + icon + '</span>' + esc(x.name) + '</div>';
                h += '<div class="project-stats" style="margin-left: auto;">' + tc + ' tasks</div>';
                h += '</div>';

                if (node.children.length > 0) {
                    h += renderProjectTree(node.children, level + 1);
                }
            });
            return h;
        }
        function renderSomeday() { var t = state.tasks.filter(function (x) { return x.status === 'someday'; }); var h = '<div class="page-header"><h2>Someday/Maybe</h2><p>Ideas for the future</p></div>'; if (t.length === 0) h += '<div class="empty-state"><span class="material-icons">cloud</span><h3>Dream Big</h3></div>'; else { h += '<div class="task-list">'; t.forEach(function (x) { h += taskItem(x); }); h += '</div>'; } return h; }
        function renderReview() {
            var ic = state.tasks.filter(function (x) { return x.status === 'inbox'; }).length;
            var h = '<div class="page-header"><h2>Weekly Review</h2><p>Get clear, current, creative</p></div>';
            h += '<div class="review-section"><h3><span class="material-icons">inbox</span> Process Inbox</h3><p>' + (ic > 0 ? ic + ' items' : 'Empty!') + '</p>' + (ic > 0 ? '<button class="btn btn-primary" onclick="navigateTo(\'inbox\')">Process</button>' : '') + '</div>';
            h += '<div class="review-section"><h3><span class="material-icons">folder</span> Review Projects</h3><button class="btn btn-secondary" onclick="navigateTo(\'projects\')">Review</button></div>';
            h += '<div class="review-section"><h3><span class="material-icons">download</span> Export Data</h3><p>Download a log of all completed tasks and projects.</p><div style="display:flex; gap:8px"><button class="btn btn-secondary" onclick="downloadExport()">Export Log</button><button class="btn btn-danger" onclick="compactDatabaseClick()">Compact Database</button></div></div>';
            return h;
        }
        function renderContexts() { var h = '<div class="page-header"><h2>Contexts</h2><p>Where you can do tasks</p></div><div class="task-list">'; state.contexts.forEach(function (c) { var n = state.tasks.filter(function (t) { return t.contextId === c.id && t.status === 'next'; }).length; h += '<div class="task-item"><span class="context-icon">' + c.icon + '</span><div class="task-content"><div class="task-title">' + esc(c.name) + '</div></div><span class="task-meta">' + n + ' next</span></div>'; }); h += '</div><button class="add-btn" onclick="addContext()"><span class="material-icons">add</span> Add Context</button>'; return h; }
        function renderAreas() { var h = '<div class="page-header"><h2>Areas</h2><p>Ongoing responsibilities</p></div><div class="task-list">'; state.areas.forEach(function (a) { var n = state.projects.filter(function (p) { return p.areaId === a.id && p.status === 'active'; }).length; h += '<div class="task-item"><span class="context-icon">' + a.icon + '</span><div class="task-content"><div class="task-title">' + esc(a.name) + '</div></div><span class="task-meta">' + n + ' projects</span></div>'; }); h += '</div><button class="add-btn" onclick="addArea()"><span class="material-icons">add</span> Add Area</button>'; return h; }
        function taskItem(t) {
            var ctx = state.contexts.find(function (c) { return c.id === t.contextId; });
            var prj = state.projects.find(function (p) { return p.id === t.projectId; });
            var h = '<div class="task-item" onclick="openItemDialog(\'' + t.id + '\')"><div class="task-checkbox" onclick="event.stopPropagation();completeTaskClick(\'' + t.id + '\')"></div><div class="task-content"><div class="task-title">' + esc(t.title);

            // Email Link Icon
            if (t.emailThreadId) {
                h += ' <a href="#" onclick="event.stopPropagation(); openGmail(\'' + t.emailThreadId + '\'); return false;" class="email-link-icon" title="Open in Gmail"><span class="material-icons" style="font-size: 16px; vertical-align: middle; color: var(--primary-color);">mail</span></a>';
            }

            h += '</div>';
            var m = []; if (ctx) m.push(ctx.icon + ' ' + ctx.name); if (prj) m.push(esc(prj.name)); if (t.dueDate) m.push(t.dueDate); if (m.length > 0) h += '<div class="task-meta">' + m.join(' &bull; ') + '</div>'; h += '</div></div>'; return h;
        }
        function handleQuickCapture(e) { if (e.key === 'Enter') submitQuickCapture(); }
        function submitQuickCapture() {
            var i = document.getElementById('quickCaptureInput');
            var t = i.value.trim();
            if (!t) return;

            // Optimistic Update
            var tempId = 'temp-' + Date.now();
            var tempTask = {
                id: tempId,
                title: t,
                status: 'inbox',
                parentTaskId: '', // Root level for Unified Inbox
                projectId: '',
                contextId: '',
                energyRequired: 'medium',
                notes: '',
                dueDate: '',
                createdDate: new Date().toISOString()
            };

            state.tasks.push(tempTask);
            updateInboxBadge();
            if (state.currentPage === 'inbox') renderPage('inbox');
            showToast('Added');
            i.value = '';

            requestQueue.enqueue('createTask', tempTask, tempId, 'Create: ' + t);
        }
        // Custom Project Dropdown Logic
        // This is now replaced by setupParentDropdown for the unified dialog.
        // Keeping the helper functions for tree building/filtering/flattening.

        // Helper: Build Tree for Dropdown
        function buildProjectDropdownTree(projects) {
            const map = {};
            const roots = [];

            // Initialize map
            projects.forEach(p => {
                map[p.id] = { project: p, children: [] };
            });

            // Link children
            projects.forEach(p => {
                if (p.parentProjectId && map[p.parentProjectId]) {
                    map[p.parentProjectId].children.push(map[p.id]);
                } else {
                    roots.push(map[p.id]);
                }
            });

            return roots; // Returns array of { project, children: [] }
        }

        // Helper: Filter Tree for Dropdown
        function filterProjectDropdownTree(nodes, term) {
            return nodes.reduce((acc, node) => {
                const matches = node.project.name.toLowerCase().includes(term);
                const filteredChildren = filterProjectDropdownTree(node.children, term);

                if (matches || filteredChildren.length > 0) {
                    acc.push({
                        project: node.project,
                        children: filteredChildren
                    });
                }
                return acc;
            }, []);
        }

        // Helper: Flatten Tree for Dropdown
        function flattenProjectDropdownTree(nodes, level = 0) {
            let result = [];
            nodes.forEach(node => {
                result.push({ project: node.project, level: level });
                result = result.concat(flattenProjectDropdownTree(node.children, level + 1));
            });
            return result;
        }

        // Unified Item Dialog Logic

        function openItemDialog(id, typeOverride, parentIdOverride) {
            // FIX: Check if this ID was recently resolved (Stale DOM click)
            if (requestQueue && requestQueue.resolvedIds[id]) {
                console.log(`openItemDialog: Redirecting Stale ID ${id} -> ${requestQueue.resolvedIds[id]}`);
                id = requestQueue.resolvedIds[id];
            }

            var item = null;
            if (id) {
                // Determine list to search based on type override or search both
                // Ideally we know if it is a task or project.
                // But simplified: check tasks then projects.
                item = state.tasks.find(function (t) { return t.id === id; });
                if (!item) {
                    item = state.projects.find(function (p) { return p.id === id; });
                }

                if (!item) {
                    console.error('Item not found:', id);
                    if (id.startsWith('temp-')) {
                        alert('This item is still syncing. Please wait a moment.');
                        return;
                    }
                }
            }

            state.currentItem = item; // Stores ref (or null for new)

            // SHOW DIALOG
            document.getElementById('itemDialog').style.display = 'flex';

            // Reset/Populate Fields
            if (item) {
                // EDIT MODE
                document.getElementById('itemDialogTitle').textContent = 'Edit Item';
                document.getElementById('itemTitle').value = item.title || item.name || '';
                document.getElementById('itemNotes').value = item.notes || item.description || '';
                document.getElementById('itemStatus').value = item.status || 'next';

                // Type Logic
                var type = item.type || (state.projects.some(p => p.id === id) ? 'project' : 'task');
                document.getElementById('itemType').value = type;

                // Parent
                var pId = item.projectId || item.parentTaskId || item.parentProjectId || '';
                document.getElementById('itemParent').value = pId;
                document.getElementById('itemParentDisplay').value = '';
                if (pId) {
                    var p = state.projects.find(x => x.id === pId);
                    if (p) document.getElementById('itemParentDisplay').value = p.name;
                }

                // Task specifics
                document.getElementById('itemContext').value = item.contextId || state.settings.defaultContext || '';
                document.getElementById('itemEnergy').value = item.energyRequired || 'medium';
                document.getElementById('itemTimeEstimate').value = item.timeEstimate || '';
                document.getElementById('itemWaitingFor').value = item.waitingFor || '';
                document.getElementById('itemImportance').value = item.importance || '2';
                document.getElementById('itemUrgency').value = item.urgency || '2';

                // Star rendering
                var starBtn = document.getElementById('itemStarBtn');
                var starIcon = document.getElementById('itemStarIcon');
                if (item.isStarred) {
                    starIcon.textContent = 'star';
                    starBtn.style.color = '#f59e0b'; // Amber-500
                    starBtn.dataset.starred = "true";
                } else {
                    starIcon.textContent = 'star_border';
                    starBtn.style.color = 'var(--text-muted)';
                    starBtn.dataset.starred = "false";
                }

                // Project specifics
                document.getElementById('itemArea').value = item.areaId || '';

                // Common
                document.getElementById('itemDueDate').value = item.dueDate || '';
                document.getElementById('itemScheduledDate').value = item.scheduledDate || '';

                // Delete Button
                document.getElementById('deleteItemBtn').style.display = 'inline-flex';

                // Email
                if (item.emailThreadId) {
                    document.getElementById('emailLink').style.display = 'block';
                    document.getElementById('emailLinkAnchor').onclick = function () { openGmail(item.emailThreadId); return false; };
                } else {
                    document.getElementById('emailLink').style.display = 'none';
                }

            } else {
                // NEW ITEM MODE
                document.getElementById('itemDialogTitle').textContent = 'New Item';
                document.getElementById('itemTitle').value = '';
                document.getElementById('itemNotes').value = '';
                document.getElementById('itemType').value = typeOverride || 'task';
                document.getElementById('itemStatus').value = 'inbox';

                document.getElementById('itemParent').value = parentIdOverride || '';
                document.getElementById('itemParentDisplay').value = '';
                if (parentIdOverride) {
                    var p = state.projects.find(x => x.id === parentIdOverride);
                    if (p) document.getElementById('itemParentDisplay').value = p.name;
                }

                document.getElementById('itemContext').value = state.settings.defaultContext || '';
                document.getElementById('itemEnergy').value = 'medium';
                document.getElementById('itemTimeEstimate').value = '';
                document.getElementById('itemTimeEstimate').value = '';
                document.getElementById('itemWaitingFor').value = '';
                document.getElementById('itemImportance').value = '2';
                document.getElementById('itemUrgency').value = '2';

                // Reset Star
                var starBtn = document.getElementById('itemStarBtn');
                var starIcon = document.getElementById('itemStarIcon');
                starIcon.textContent = 'star_border';
                starBtn.style.color = 'var(--text-muted)';
                starBtn.dataset.starred = "false";
                document.getElementById('itemArea').value = '';
                document.getElementById('itemDueDate').value = '';
                document.getElementById('itemScheduledDate').value = '';

                document.getElementById('deleteItemBtn').style.display = 'none';
                document.getElementById('emailLink').style.display = 'none';
            }

            updateDialogVisibility();
            setupParentDropdown();
        }

        function toggleItemStar() {
            var btn = document.getElementById('itemStarBtn');
            var icon = document.getElementById('itemStarIcon');
            var isStarred = btn.dataset.starred === "true";

            if (isStarred) {
                // Turn off
                btn.dataset.starred = "false";
                icon.textContent = 'star_border';
                btn.style.color = 'var(--text-muted)';
            } else {
                // Turn on
                btn.dataset.starred = "true";
                icon.textContent = 'star';
                btn.style.color = '#f59e0b';
            }
        }

        function updateDialogVisibility() {
            var type = document.getElementById('itemType').value;
            var status = document.getElementById('itemStatus').value;

            var taskFields = document.getElementById('taskFields');
            var projectFields = document.getElementById('projectFields');

            if (type === 'task') {
                taskFields.style.display = 'block';
                projectFields.style.display = 'none';

                // Status specific visibility (e.g. Waiting For)
                document.getElementById('itemWaitingForGroup').style.display = (status === 'waiting') ? 'block' : 'none';

                // Allow editing scheduled date for any status (it might trigger status change logic in backend or just be metadata)
                document.getElementById('scheduledDateGroup').style.display = 'block';

            } else {
                // Project or Folder
                taskFields.style.display = 'none';
                projectFields.style.display = 'block';

                // Auto-switch status to 'active' if current status is transient (inbox/next/waiting/scheduled?)
                // Users expect projects to be Active by default if they are promoting a task.
                if (status === 'inbox' || status === 'next' || status === 'waiting') {
                    document.getElementById('itemStatus').value = 'active';
                }

                document.getElementById('itemWaitingForGroup').style.display = 'none';
                document.getElementById('scheduledDateGroup').style.display = 'block'; // Allow for projects too
            }
        }

        function saveItem() {
            var id = state.currentItem ? state.currentItem.id : null;
            var type = document.getElementById('itemType').value;

            var d = {
                title: document.getElementById('itemTitle').value,
                notes: document.getElementById('itemNotes').value,
                status: document.getElementById('itemStatus').value,
                type: type,
                dueDate: document.getElementById('itemDueDate').value
            };

            // Parent ID
            // Unified parent field - maps to different DB fields based on type, OR we can normalize in backend?
            // Backend TaskService: parentTaskId is used for hierarchy.
            // Backend ProjectService (which wraps TaskService): uses parentTaskId mapping to parentProjectId.
            // Task: can have projectId (if regular task in project) or parentTaskId (if subtask).
            // Current model: 
            // - Task in Project: projectId = P_ID, parentTaskId = '' (or subtask ID)
            // - Project in Project: parentTaskId = P_ID
            // - Task in Inbox: parentTaskId = '', projectId = ''

            var parentId = document.getElementById('itemParent').value;

            if (type === 'task') {
                // Fields
                d.contextId = document.getElementById('itemContext').value;
                d.energyRequired = document.getElementById('itemEnergy').value;
                d.timeEstimate = document.getElementById('itemTimeEstimate').value;
                d.waitingFor = document.getElementById('itemWaitingFor').value;
                d.importance = document.getElementById('itemImportance').value;
                d.urgency = document.getElementById('itemUrgency').value;

                // Star collection
                var starBtn = document.getElementById('itemStarBtn');
                d.isStarred = (starBtn.dataset.starred === "true");
                d.scheduledDate = document.getElementById('itemScheduledDate').value;

                // Parent Mapping
                d.projectId = parentId; // For tasks, we treat the parent container as the project
                d.parentTaskId = ''; // Reset subtask nesting if moved to project root? 
                // Advanced: if we wanted to support subtasks, we'd need to know if parentId is a Task or Project.
                // For now, simplifed: Parent is always a Project/Folder.
            } else {
                // Project or Folder
                // DB expects 'name' and 'description' for legacy component?
                // But unified ProjectService.createProject maps 'name' -> 'title', 'description' -> 'notes'.
                // So passing 'title'/'notes' directly to updateTask is fine if we bypass ProjectService wrapper?
                // Wait, Code.gs updateProject calls ProjectService.updateProject which maps name->title.
                // Let's pass 'name'/'description' aliased to be safe if routed through ProjectService.
                d.name = d.title;
                d.description = d.notes;

                d.areaId = document.getElementById('itemArea').value;
                d.parentProjectId = parentId; // Projects nest via parentProjectId
            }

            // Optimistic Update
            // This is complex because we might be switching lists (Task <-> Project)
            // Easier to just show loading and wait for server re-load usually, or try partial update.
            // Let's do a basic optimistic update if ID exists and type didn't change group (Task->Task).

            if (id) {
                // Update existing
                showToast('Queued...');

                if (type === 'task') {
                    requestQueue.enqueue('updateTask', { id: id, updates: d }, null, 'Update: ' + d.title);
                } else {
                    requestQueue.enqueue('updateProject', { id: id, updates: d }, null, 'Update: ' + (d.name || d.title));
                }
            } else {
                // Create New (Full Dialog)
                showToast('Queued...');
                var tempId = 'temp-' + Date.now();
                // We don't have a full local optimistic update for Dialog creation yet (unlike Quick Capture), 
                // but we can add one if we want. For now, let's just queue it.
                // Actually, if we want "Create then Edit" loop to work for Dialog creations too, we need a Temp ID.

                // Let's attach the Temp ID to the data so backend *could* ignore it, or just use it for queue resolution.

                if (type === 'task') {
                    // Normalize data for validation if needed, or backend handles it.
                    // Backend expects object.
                    requestQueue.enqueue('createTask', d, tempId, 'Create: ' + d.title);
                } else {
                    requestQueue.enqueue('createProject', d, tempId, 'Create: ' + (d.name || d.title));
                }
            }

            closeItemDialog();
        }

        function handleSaveSuccess(r) {
            if (r && r.success) {
                showToast('Saved');
                loadAllData(); // Refresh everything to be safe
            } else {
                showToast('Error: ' + (r ? r.error : 'Unknown'));
            }
        }

        function closeItemDialog() {
            document.getElementById('itemDialog').style.display = 'none';
            state.currentItem = null;
        }

        function deleteCurrentItem() {
            if (!state.currentItem || !confirm('Delete this item?')) return;
            var id = state.currentItem.id;
            var type = document.getElementById('itemType').value;
            var title = state.currentItem.title || state.currentItem.name;

            if (type === 'task') {
                requestQueue.enqueue('deleteTask', { id: id }, null, 'Delete: ' + title);
            } else {
                requestQueue.enqueue('deleteProject', { id: id }, null, 'Delete: ' + title);
            }
            closeItemDialog();
        }

        // Custom Parent Dropdown Logic for Item Dialog
        function setupParentDropdown() {
            // Similar to previous setupProjectDropdown but targeting new IDs
            const container = document.getElementById('itemParentContainer');
            const display = document.getElementById('itemParentDisplay');
            const hidden = document.getElementById('itemParent');
            const dropdown = document.getElementById('itemParentDropdown');

            // Remove old listeners to avoid dupes? (Not easy)
            // Simpler: use onfocus/oninput in HTML or valid "one-time" setup check
            // or just re-attach.

            display.onfocus = function () {
                renderParentDropdown(state.projects, display.value);
                dropdown.style.display = 'block';
            };

            display.oninput = function () {
                renderParentDropdown(state.projects, display.value);
                dropdown.style.display = 'block';
            };

        }

        // Global click listener for Item Dialog Dropdown
        document.addEventListener('click', function (e) {
            const container = document.getElementById('itemParentContainer');
            const dropdown = document.getElementById('itemParentDropdown');
            if (container && dropdown && !container.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        function renderParentDropdown(projects, searchTerm) {
            const dropdown = document.getElementById('itemParentDropdown');
            dropdown.innerHTML = '';

            // Add "Inbox / No Parent" option
            var noneDiv = document.createElement('div');
            noneDiv.className = 'dropdown-item';
            noneDiv.textContent = 'None (Root)';
            noneDiv.onclick = function () {
                document.getElementById('itemParent').value = '';
                document.getElementById('itemParentDisplay').value = '';
                dropdown.style.display = 'none';
            };
            dropdown.appendChild(noneDiv);

            // Reuse the tree builder logic from before
            // Filter active projects
            var active = projects.filter(p => p.status !== 'dropped' && p.status !== 'completed'); // Show folders too? Yes.

            var tree = buildProjectDropdownTree(active);
            if (searchTerm) tree = filterProjectDropdownTree(tree, searchTerm.toLowerCase());
            var flat = flattenProjectDropdownTree(tree);

            flat.forEach(item => {
                const div = document.createElement('div');
                div.className = `dropdown-item level-${Math.min(item.level, 4)}`;
                var icon = item.project.type === 'folder' ? 'folder_open' : 'folder';
                div.innerHTML = `<span class="material-icons project-icon">${icon}</span>${esc(item.project.name)}`;
                div.onclick = function () {
                    document.getElementById('itemParent').value = item.project.id;
                    document.getElementById('itemParentDisplay').value = item.project.name;
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(div);
            });
        }

        // --- End Unified Logic ---
        function convertCurrentTask() {
            if (!state.currentItem || state.currentItem.type !== 'task' || !confirm('Convert this task to a project? The task will be deleted and its sub-tasks moved.')) return;

            var taskId = state.currentItem.id;
            showToast('Converting...');
            closeItemDialog();

            // Optimistic update
            var idx = state.tasks.findIndex(function (x) { return x.id === taskId; });
            if (idx !== -1) {
                state.tasks.splice(idx, 1);
                renderPage(state.currentPage);
            }

            // Queue Request
            requestQueue.enqueue('convertTask', { id: taskId }, null, 'Convert to Project');
        }

        function downloadExport() {
            showToast('Generating export...');
            google.script.run.withSuccessHandler(function (csv) {
                var blob = new Blob([csv], { type: 'text/csv' });
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'completed_log.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showToast('Download started');
            }).withFailureHandler(function (e) {
                showToast('Error: ' + e);
            }).exportCompletedItems();
        }

        function compactDatabaseClick() {
            if (!confirm('WARNING: This will PERMANENTLY DELETE all completed tasks, deleted tasks, completed projects, and dropped projects.\n\nThis action cannot be undone.\n\nAre you sure you want to proceed?')) return;

            showToast('Compacting database...');
            google.script.run.withSuccessHandler(function (r) {
                showToast('Removed ' + r.tasksRemoved + ' tasks and ' + r.projectsRemoved + ' projects.');
                loadAllData();
            }).withFailureHandler(function (e) {
                showToast('Error: ' + e);
            }).compactDatabase();
        }

        function importGmail() {
            showLoading(true);
            google.script.run.withSuccessHandler(function (r) {
                showLoading(false);
                if (r.success) {
                    showToast('Imported ' + r.count + ' tasks');
                    loadAllData();
                } else {
                    showToast('Error: ' + r.error);
                }
            }).withFailureHandler(function (e) { showToast('Error: ' + e); showLoading(false); }).importGmailTasks();
        }

        function scanInbox() {
            var totalProcessed = 0;
            var isScanning = true;

            function runBatch() {
                if (!isScanning) return;
                showLoading(true);
                showToast('Scanning... (Processed: ' + totalProcessed + ')');

                google.script.run.withSuccessHandler(function (r) {
                    totalProcessed += r.count;

                    if (r.complete) {
                        showLoading(false);
                        showToast('Scan Complete. Total Processed: ' + totalProcessed);
                        isScanning = false;
                    } else if (r.count === 0 && r.threadsFound > 0) {
                        // Stagnation detection: Found threads but couldn't process any
                        showLoading(false);
                        var errorMsg = r.error ? ': ' + r.error : '.';
                        showToast('Scan Aborted. Error' + errorMsg);
                        isScanning = false;
                    } else {
                        // Continue scanning
                        runBatch();
                    }
                }).withFailureHandler(function (e) {
                    showToast('Error: ' + e);
                    showLoading(false);
                    isScanning = false;
                }).scanInboxForSuggestions();
            }

            runBatch();
        }

        function saveAttentionFixes() {
            var items = document.querySelectorAll('#attentionFixList .fix-item');
            var updates = [];

            items.forEach(function (el) {
                var id = el.dataset.id;
                var original = state.tasks.find(function (t) { return t.id === id; });
                if (!original) return;

                var u = {};
                var hasUpdates = false;

                // Helper to compare values loosely
                function isChanged(newVal, oldVal) {
                    var n = newVal || '';
                    var o = oldVal || '';
                    return n !== o;
                }

                var contextSelect = el.querySelector('.fix-context');
                // Context is a "Command" input (starts empty). Only update if user selected something different.
                if (contextSelect && contextSelect.value && contextSelect.value !== (original.contextId || '')) {
                    u.contextId = contextSelect.value;
                    hasUpdates = true;
                }

                var timeInput = el.querySelector('.fix-time');
                // Time is a "Command" input (starts empty). Only update if user entered something.
                if (timeInput && timeInput.value && timeInput.value != (original.timeEstimate || '')) {
                    u.timeEstimate = timeInput.value;
                    hasUpdates = true;
                }

                var statusSelect = el.querySelector('.fix-status');
                // Status is a "Command" input (starts empty). Only update if selected.
                if (statusSelect && statusSelect.value && statusSelect.value !== (original.status || '')) {
                    u.status = statusSelect.value;
                    hasUpdates = true;
                }

                // Importance (Command)
                var impSelect = el.querySelector('.fix-importance');
                if (impSelect && impSelect.value && impSelect.value !== (original.importance || '')) {
                    u.importance = impSelect.value;
                    hasUpdates = true;
                }

                // Urgency (Command)
                var urgSelect = el.querySelector('.fix-urgency');
                if (urgSelect && urgSelect.value && urgSelect.value !== (original.urgency || '')) {
                    u.urgency = urgSelect.value;
                    hasUpdates = true;
                }

                var typeSelect = el.querySelector('.fix-type');
                // Type is a "State" input (pre-filled). Compare current vs original.
                // Normalize original type: undefined/'task' are equivalent.
                var originalType = original.type || 'task';
                if (typeSelect && typeSelect.value !== originalType) {
                    u.type = typeSelect.value;
                    hasUpdates = true;

                    // Auto-set status to 'active' if converting to Project/Folder and status is not explicitly set or remains 'inbox'
                    if ((u.type === 'project' || u.type === 'folder') && !u.status && original.status === 'inbox') {
                        u.status = 'active';
                    }
                }

                var scheduledInput = el.querySelector('.fix-scheduled');
                // Date is a "State" input (pre-filled). Compare.
                if (scheduledInput && isChanged(scheduledInput.value, original.scheduledDate)) {
                    u.scheduledDate = scheduledInput.value;
                    hasUpdates = true;
                }

                var dueInput = el.querySelector('.fix-due');
                // Date is a "State" input (pre-filled). Compare.
                if (dueInput && isChanged(dueInput.value, original.dueDate)) {
                    u.dueDate = dueInput.value;
                    hasUpdates = true;
                }

                if (hasUpdates) {
                    updates.push({ id: id, updates: u });
                }
            });

            if (updates.length === 0) {
                showToast('No changes to save');
                return;
            }

            showLoading(true, 'Preparing updates...');

            // Use chunking helper (batch size 5)
            processUpdatesInChunks(updates, 5,
                function (msg) {
                    showLoading(true, msg);
                },
                function (result) {
                    if (result.success) {
                        showToast('Fixed ' + result.count + ' tasks');
                        loadAllData();
                    } else {
                        showToast('Error: ' + result.error);
                        showLoading(false);
                    }
                }
            );
        }

        function saveInboxUpdates() {
            var items = document.querySelectorAll('#inboxList .fix-item');
            var updates = [];

            items.forEach(function (el) {
                var id = el.dataset.id;
                var u = {};
                var hasUpdates = false;

                // Type
                var type = el.querySelector('.fix-type');
                if (type && type.value) {
                    u.type = type.value;
                    hasUpdates = true;

                    // Auto-set status to 'active' if converting to Project/Folder and status is not explicitly set or remains 'inbox'
                    // Check if status is being updated
                    var stat = el.querySelector('.fix-status');
                    var statusValue = stat ? stat.value : '';

                    if ((type.value === 'project' || type.value === 'folder') && (!statusValue || statusValue === 'inbox')) {
                        u.status = 'active';
                    }
                }

                // Project
                var proj = el.querySelector('.fix-project');
                if (proj && proj.value) { u.projectId = proj.value; hasUpdates = true; }

                // Context
                var ctx = el.querySelector('.fix-context');
                if (ctx && ctx.value) { u.contextId = ctx.value; hasUpdates = true; }

                // Status
                var stat = el.querySelector('.fix-status');
                if (stat && stat.value && stat.value !== 'inbox') {
                    u.status = stat.value;
                    hasUpdates = true;
                }

                // Due Date
                var due = el.querySelector('.fix-due');
                if (due && due.value) { u.dueDate = due.value; hasUpdates = true; }

                // Scheduled Date
                var sched = el.querySelector('.fix-scheduled');
                if (sched && sched.value) { u.scheduledDate = sched.value; hasUpdates = true; }

                // Time
                var time = el.querySelector('.fix-time');
                if (time && time.value) { u.timeEstimate = time.value; hasUpdates = true; }

                // Energy
                var energy = el.querySelector('.fix-energy');
                if (energy && energy.value && energy.value !== 'medium') { u.energyRequired = energy.value; hasUpdates = true; }

                // Importance
                var imp = el.querySelector('.fix-importance');
                if (imp && imp.value) { u.importance = imp.value; hasUpdates = true; }

                // Urgency
                var urg = el.querySelector('.fix-urgency');
                if (urg && urg.value) { u.urgency = urg.value; hasUpdates = true; }

                // Star
                var star = el.querySelector('.fix-star');
                if (star) {
                    var isStarred = (star.dataset.starred === 'true');
                    // Only update if strictly changed from original? 
                    // Complexity: 'original' is not easily accessible here without lookup.
                    // But we can check if it differs from default? No, just send it if true, or if likely changed.
                    // Simplest: Send if present. Backend handles merging.
                    u.isStarred = isStarred;
                    hasUpdates = true;
                }

                if (hasUpdates) {
                    updates.push({ id: id, updates: u });
                }
            });

            if (updates.length === 0) {
                showToast('No changes made');
                return;
            }

            showLoading(true);
            google.script.run.withSuccessHandler(function (r) {
                if (r.success) {
                    showToast('Processed ' + r.count + ' items');
                    loadAllData();
                } else {
                    showToast('Error: ' + r.error);
                    showLoading(false);
                }
            }).withFailureHandler(function (e) {
                showToast('Error: ' + e);
                showLoading(false);
            }).updateTasks(updates);
        }

        function toggleBulkStar(el) {
            var isStarred = el.dataset.starred === 'true';
            if (isStarred) {
                el.dataset.starred = 'false';
                el.innerText = 'star_border';
                el.style.color = 'var(--text-muted)';
            } else {
                el.dataset.starred = 'true';
                el.innerText = 'star';
                el.style.color = '#f59e0b';
            }
        }

        function saveProjectAttentionFixes() {
            var items = document.querySelectorAll('#attentionProjectFixList .fix-item');
            var updates = [];

            items.forEach(function (el) {
                var id = el.dataset.id;
                var original = state.projects.find(function (p) { return p.id === id; });
                if (!original) return;

                var statusSelect = el.querySelector('.fix-status');
                var scheduledInput = el.querySelector('.fix-scheduled');
                var dueInput = el.querySelector('.fix-due');

                var u = {};
                var hasUpdates = false;

                // Helper to compare values loosely
                function isChanged(newVal, oldVal) {
                    var n = newVal || '';
                    var o = oldVal || '';
                    // Project status mapping: 'completed' in UI might be 'done' in state if normalized?
                    // ProjectService.taskToProject maps internal 'done' to 'completed'.
                    // So state.projects have 'completed'.
                    return n !== o;
                }

                if (statusSelect && statusSelect.value && isChanged(statusSelect.value, original.status)) {
                    var val = statusSelect.value;
                    u.status = val;
                    if (u.status === 'completed') u.status = 'done';
                    hasUpdates = true;
                }

                if (scheduledInput && isChanged(scheduledInput.value, original.scheduledDate)) {
                    u.scheduledDate = scheduledInput.value;
                    hasUpdates = true;
                }

                if (dueInput && isChanged(dueInput.value, original.dueDate)) {
                    u.dueDate = dueInput.value;
                    hasUpdates = true;
                }

                if (hasUpdates) {
                    updates.push({ id: id, updates: u });
                }
            });

            if (updates.length === 0) {
                showToast('No changes to save');
                return;
            }

            showLoading(true, 'Preparing updates...');

            // Use chunking helper (batch size 5)
            processUpdatesInChunks(updates, 5,
                function (msg) {
                    showLoading(true, msg);
                },
                function (result) {
                    if (result.success) {
                        showToast('Updated ' + result.count + ' projects');
                        loadAllData();
                    } else {
                        showToast('Error: ' + result.error);
                        showLoading(false);
                    }
                }
            );
        }

        function completeTaskClick(id) {
            // Optimistic update
            var t = state.tasks.find(function (x) { return x.id === id; });
            if (t) {
                t.status = 'done';
                // Remove from view immediately
                renderPage(state.currentPage);
                updateInboxBadge();
                updateNextActionsBadge();
            }

            // Queue Request
            requestQueue.enqueue('completeTask', { id: id }, null, 'Complete Task');
            // Note: The RequestQueue generic handler doesn't have specific revert logic for this custom UI logic
            // But since we process serially, if it fails, the global error handler in RequestQueue will create a toast.
            // For a robust optimistic revert, we'd need to add that callback to the queue item or handle it in the generic handler.
            // Given the complexity/rarity, we'll stick to the generic error toast for now. If it fails, a subsequent reloadAllData() (triggered manually or auto) fixes it.
        }


        function updateCurrentContext() { google.script.run.updateSetting('currentContext', document.getElementById('currentContext').value); }
        function updateCurrentEnergy() { google.script.run.updateSetting('currentEnergyLevel', document.getElementById('currentEnergy').value); }

        function showLoading(s, msg) {
            var l = document.getElementById('loading');
            var c = document.getElementById('pageContent');
            var t = document.getElementById('loading-text');
            if (l) l.style.display = s ? 'flex' : 'none';
            if (c) c.style.display = s ? 'none' : 'block';
            if (t) t.textContent = msg || 'Loading...';
        }

        /**
         * Process updates in chunks to prevent timeout and show progress
         */
        function processUpdatesInChunks(updates, batchSize, onProgress, onComplete) {
            if (updates.length === 0) {
                onComplete({ success: true, count: 0 });
                return;
            }

            var total = updates.length;
            var processed = 0;
            var successes = 0;
            var errors = [];
            var chunks = [];

            // Split into chunks
            for (var i = 0; i < total; i += batchSize) {
                chunks.push(updates.slice(i, i + batchSize));
            }

            function processNextChunk(chunkIndex) {
                if (chunkIndex >= chunks.length) {
                    onComplete({
                        success: errors.length === 0,
                        count: successes,
                        error: errors.join('; ')
                    });
                    return;
                }

                var chunk = chunks[chunkIndex];
                var currentBatchStart = chunkIndex * batchSize + 1;
                var currentBatchEnd = Math.min((chunkIndex + 1) * batchSize, total);

                onProgress('Processing items ' + currentBatchStart + ' - ' + currentBatchEnd + ' of ' + total + '...');

                google.script.run.withSuccessHandler(function (r) {
                    if (r.success) {
                        successes += r.count;
                    } else {
                        errors.push(r.error);
                    }
                    processed += chunk.length;
                    processNextChunk(chunkIndex + 1);
                }).withFailureHandler(function (e) {
                    errors.push('Batch failed: ' + e);
                    processed += chunk.length;
                    processNextChunk(chunkIndex + 1);
                }).updateTasks(chunk);
            }

            // Start processing
            processNextChunk(0);
        }
        function showToast(m) { var t = document.getElementById('toast'); if (!t) return; t.textContent = m; t.classList.add('show'); setTimeout(function () { t.classList.remove('show'); }, 3000); }
        function esc(t) { if (!t) return ''; var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function addContext() { var n = prompt('Context name:'); if (!n) return; var i = prompt('Emoji:', ''); google.script.run.withSuccessHandler(function (c) { state.contexts.push(c); populateSelects(); renderPage('contexts'); showToast('Added'); }).withFailureHandler(function (e) { showToast('Error: ' + e); }).createContext({ name: n, icon: i || '' }); }
        function addArea() { var n = prompt('Area name:'); if (!n) return; var i = prompt('Emoji:', ''); google.script.run.withSuccessHandler(function (a) { state.areas.push(a); populateSelects(); renderPage('areas'); showToast('Added'); }).withFailureHandler(function (e) { showToast('Error: ' + e); }).createArea({ name: n, icon: i || '' }); }




        // --- Request Queue System ---

        class RequestQueue {
            constructor() {
                this.queue = [];
                this.isProcessing = false;
                this.resolvedIds = {}; // Cache map of tempId -> realId
            }

            // Add a request to the queue
            // type: 'createTask', 'updateTask', etc.
            // data: payload object
            // tempId: optional temporary ID associated with this request (for resolution)
            // description: Text to show in UI
            enqueue(type, data, tempId, description) {
                // 1. Check if any part of 'data' uses a Temp ID that is ALREADY resolved
                if (this.resolvedIds[data.id]) {
                    console.log(`Enqueue: Auto-resolving known ID ${data.id} -> ${this.resolvedIds[data.id]}`);
                    data.id = this.resolvedIds[data.id];
                }
                // Check updates payload if present
                if (data.updates) {
                    if (data.updates.projectId && this.resolvedIds[data.updates.projectId]) {
                        data.updates.projectId = this.resolvedIds[data.updates.projectId];
                    }
                }

                const request = {
                    id: 'req-' + Date.now() + Math.random().toString(36).substr(2, 9),
                    type: type,
                    data: data,
                    tempId: tempId || null,
                    description: description || 'Updating...',
                    status: 'pending',
                    retryCount: 0
                };

                this.queue.push(request);
                this.renderUI();
                this.process();
            }

            // Process the next item in queue
            process() {
                if (this.isProcessing || this.queue.length === 0) return;

                const req = this.queue[0];
                this.isProcessing = true;
                req.status = 'processing';
                this.renderUI();

                // Execute based on type
                const handler = this.getHandler(req);

                if (!handler) {
                    console.error('No handler for type:', req.type);
                    this.completeRequest(req, false, 'Unknown request type');
                    return;
                }

                // TIMEOUT SAFETY: Fail request if it takes too long (30s)
                const timeoutMs = 30000;
                const timeoutId = setTimeout(() => {
                    if (req.status === 'processing') {
                        console.error('Request timed out:', req);
                        this.completeRequest(req, false, 'Request timed out. Please try refreshing.');
                    }
                }, timeoutMs);

                req.timeoutId = timeoutId;

                try {
                    handler(req.data)
                        .then(response => {
                            clearTimeout(timeoutId);
                            this.completeRequest(req, true, response);
                        })
                        .catch(error => {
                            clearTimeout(timeoutId);
                            this.completeRequest(req, false, error);
                        });
                } catch (e) {
                    clearTimeout(timeoutId);
                    this.completeRequest(req, false, 'Client Handler Error: ' + e);
                }
            }

            getHandler(req) {
                // Return a promise-wrapping function for Google Script calls
                return (data) => {
                    return new Promise((resolve, reject) => {
                        // DEFENSIVE CHECK: Ensure ID is resolved even if queue iteration missed it
                        if (data.id && this.resolvedIds[data.id]) {
                            console.log(`Handler: Late-resolving ID ${data.id} -> ${this.resolvedIds[data.id]}`);
                            data.id = this.resolvedIds[data.id];
                        }
                        // Also check updates.projectId / parentTaskId
                        if (data.updates) {
                            if (data.updates.projectId && this.resolvedIds[data.updates.projectId]) {
                                data.updates.projectId = this.resolvedIds[data.updates.projectId];
                            }
                            if (data.updates.parentTaskId && this.resolvedIds[data.updates.parentTaskId]) {
                                data.updates.parentTaskId = this.resolvedIds[data.updates.parentTaskId];
                            }
                        }

                        const run = google.script.run
                            .withSuccessHandler(res => {
                                // ...
                                if (res && res.success === false) reject(res.error);
                                else resolve(res); // Task/Object returned directly or {success:true}
                            })
                            .withFailureHandler(err => reject(err));

                        switch (req.type) {
                            case 'createTask': run.createTaskWrapper(data); break;
                            case 'updateTask': run.updateTask(data.id, data.updates); break;
                            case 'deleteTask': run.deleteTask(data.id); break;

                            case 'createProject': run.createProject(data); break;
                            case 'updateProject': run.updateProject(data.id, data.updates); break;
                            case 'deleteProject': run.deleteProject(data.id); break;

                            case 'convertTask': run.convertTaskToProject(data.id); break;
                            case 'completeTask': run.completeTask(data.id); break;
                            case 'completeProject': run.completeProject(data.id); break;

                            default: reject('Unknown operation');
                        }
                    });
                };
            }

            completeRequest(req, success, result) {
                try {
                    this.isProcessing = false;

                    if (success) {
                        // ID Resolution
                        // Result might be the object directly (from direct service call) OR a wrapper { success: true, task: ... }
                        // Wrapper usually used for Create calls
                        let realObj = result;
                        if (result && result.task) realObj = result.task; // Fix for createTaskWrapper
                        else if (result && result.project) realObj = result.project; // Potential fix for createProject

                        // Fallback to result if it has .id directly (e.g. from service directly)

                        if ((req.type === 'createTask' || req.type === 'createProject') && req.tempId && realObj && realObj.id) {
                            const realId = realObj.id;
                            this.resolvedIds[req.tempId] = realId; // Store in cache

                            // 1. Resolve pending queue items
                            this.resolveIds(req.tempId, realId);

                            // 2. Update Local State (Tasks Array)
                            let collection = (req.type === 'createProject') ? state.projects : state.tasks;
                            const localIdx = collection.findIndex(t => t.id === req.tempId);

                            if (localIdx !== -1) {
                                collection[localIdx] = realObj;

                                // 3. Fix Critical Bug: Update state.currentItem if it matches!
                                if (state.currentItem && state.currentItem.id === req.tempId) {
                                    console.log('Updating state.currentItem reference to real object');
                                    state.currentItem = realObj;
                                }
                            }
                        }

                        // FIX: Also update local state for Update operations!
                        // If we edited coordinates/notes, we want local state to match server state immediately
                        if ((req.type === 'updateTask' || req.type === 'updateProject') && realObj && realObj.id) {
                            let collection = (req.type === 'updateProject') ? state.projects : state.tasks;
                            const localIdx = collection.findIndex(t => t.id === realObj.id);
                            if (localIdx !== -1) {
                                collection[localIdx] = realObj;
                                // Update currentItem if it's the one open
                                if (state.currentItem && state.currentItem.id === realObj.id) {
                                    state.currentItem = realObj;
                                }
                            }
                        }

                        // FIX: Remove items from local state on delete operations!
                        if ((req.type === 'deleteTask' || req.type === 'deleteProject')) {
                            const idToDelete = req.data.id;
                            let collection = (req.type === 'deleteProject') ? state.projects : state.tasks;
                            const localIdx = collection.findIndex(t => t.id === idToDelete);
                            if (localIdx !== -1) {
                                console.log('Removing deleted item from local state:', idToDelete);
                                collection.splice(localIdx, 1);
                                if (state.currentItem && state.currentItem.id === idToDelete) {
                                    state.currentItem = null;
                                }
                            }
                        }

                        // Remove from queue
                        this.queue.shift();
                        this.renderUI();

                        // 4. Critical: Re-render the page so DOM onclick handlers use the Real ID
                        try {
                            if (typeof renderPage === 'function') {
                                renderPage(state.currentPage);
                            }
                            // Explicitly update badges
                            if (typeof updateInboxBadge === 'function') updateInboxBadge();
                            if (typeof updateAttentionBadge === 'function') updateAttentionBadge();
                            if (typeof updateNextActionsBadge === 'function') updateNextActionsBadge();
                        } catch (e) { console.error('Render error:', e); }
                    } else {
                        console.error('Request failed:', req, result);
                        req.status = 'error';
                        req.error = result;
                        req.retryCount++;

                        showToast('Sync Error: ' + result);
                        this.queue.shift(); // Drop it for now to unblock
                        this.renderUI();
                    } // End if(success)

                } catch (e) {
                    console.error('CRITICAL QUEUE ERROR:', e);
                    this.isProcessing = false;
                    this.queue.shift(); // Force unblock
                    this.renderUI();
                }

                // Trigger next loop safely
                setTimeout(() => this.process(), 50);
            }

            // Update pending requests to use Real ID instead of Temp ID
            resolveIds(tempId, realId) {
                console.log(`Resolving Queue ID: ${tempId} -> ${realId}`);
                this.queue.forEach(q => {
                    // Check payload for IDs
                    // updateTask: data.id
                    if (q.data && q.data.id === tempId) {
                        q.data.id = realId;
                    }
                    // Parent IDs? 
                    if (q.data && q.data.updates && q.data.updates.projectId === tempId) {
                        q.data.updates.projectId = realId;
                    }
                    if (q.data && q.data.updates && q.data.updates.parentTaskId === tempId) {
                        q.data.updates.parentTaskId = realId;
                    }
                    // Handle other references as needed
                });
            }

            renderUI() {
                const container = document.getElementById('queueStatus');
                const list = document.getElementById('queueList');
                const count = document.getElementById('queueCount');

                if (this.queue.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                count.textContent = this.queue.length;

                let h = '';
                this.queue.forEach(req => {
                    let icon = 'hourglass_empty';
                    if (req.status === 'processing') icon = 'sync';
                    if (req.status === 'error') icon = 'error';

                    h += `<div class="queue-item ${req.status}">
                        <span class="material-icons status-icon">${icon}</span>
                        <span>${req.description}</span>
                    </div>`;
                });
                list.innerHTML = h;
            }
        }

        const requestQueue = new RequestQueue();

        document.addEventListener('DOMContentLoaded', function () { init('inbox'); });
        function openGmail(threadId) {
            var userAgent = navigator.userAgent || navigator.vendor || window.opera;
            var isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;

            if (isIOS) {
                // iOS: Try to open Gmail app (googlegmail://)
                window.location.href = 'googlegmail://';
            } else {
                // Android & Desktop

                // Construct the standard web link.
                // Note: We avoid Android "deep links" (intent://, gmail.app.goo.gl) because
                // they crash or fail to open specific threads. The standard URL allows
                // the "Request Desktop Site" workaround on Android.
                var webUrl = 'https://mail.google.com/mail/u/0/#inbox/' + threadId;
                window.open(webUrl, '_blank');
            }
        }
    </script>
</body>

</html>