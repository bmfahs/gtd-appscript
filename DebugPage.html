<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .success {
            background: #d4edda;
        }

        .error {
            background: #f8d7da;
        }

        .pending {
            background: #fff3cd;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow: auto;
        }
    </style>
</head>

<body>
    <h1>GTD System - Debug Page</h1>

    <p>Use this page to test if the backend is working correctly.</p>

    <div id="results"></div>

    <h2>Tests</h2>

    <button onclick="testPing()">1. Test Ping (basic connectivity)</button>
    <button onclick="testSheetConnection()">2. Test Sheet Connection</button>
    <button onclick="testInitialize()">3. Run initializeSystem()</button>
    <button onclick="testReadTasks()">4. Debug Read Tasks</button>
    <button onclick="testGetAllData()">5. Test getAllData()</button>
    <button onclick="testQuickCapture()">6. Test quickCapture()</button>
    <button onclick="runMigration()" style="background-color: #ffeeba; border-color: #ffdf7e;">⚠️ 7. Run Project
        Migration</button>

    <h2>Import Data</h2>
    <div class="test">
        <input type="file" id="importFile" accept=".xml">
        <button onclick="importMloData()">Import MLO XML</button>
        <button onclick="inspectProjects()">Inspect Projects Sheet</button>
        <button onclick="fixHeaders()">Fix Project Headers</button>
    </div>

    <h2>Results</h2>
    <div id="output"></div>

    <script>
        function log(message, isError) {
            var output = document.getElementById('output');
            var div = document.createElement('div');
            div.className = 'test ' + (isError ? 'error' : 'success');
            div.innerHTML = '<pre>' + (typeof message === 'object' ? JSON.stringify(message, null, 2) : message) + '</pre>';
            output.insertBefore(div, output.firstChild);
        }

        function testPing() {
            log('Calling ping()...', false);
            google.script.run
                .withSuccessHandler(function (result) { log('ping() SUCCESS:\n' + JSON.stringify(result, null, 2), false); })
                .withFailureHandler(function (error) { log('ping() FAILED:\n' + (error.message || error), true); })
                .ping();
        }

        function testSheetConnection() {
            log('Calling testSheetConnection()...', false);
            google.script.run
                .withSuccessHandler(function (result) {
                    log('testSheetConnection():\n' + JSON.stringify(result, null, 2), !result.success);
                })
                .withFailureHandler(function (error) { log('testSheetConnection() FAILED:\n' + (error.message || error), true); })
                .testSheetConnection();
        }

        function testReadTasks() {
            log('Calling debugReadTasks()...', false);
            google.script.run
                .withSuccessHandler(function (result) {
                    var hasErrors = result.errors && result.errors.length > 0;
                    log('debugReadTasks():\n' + JSON.stringify(result, null, 2), hasErrors);
                })
                .withFailureHandler(function (error) { log('debugReadTasks() FAILED:\n' + (error.message || error), true); })
                .debugReadTasks();
        }

        function testGetAllData() {
            log('Calling getAllData()...', false);
            google.script.run
                .withSuccessHandler(function (data) { log('getAllData() SUCCESS:\n' + JSON.stringify(data, null, 2), false); })
                .withFailureHandler(function (error) { log('getAllData() FAILED:\n' + (error.message || error), true); })
                .getAllData();
        }

        function testQuickCapture() {
            var title = 'Test task ' + new Date().toLocaleTimeString();
            log('Calling quickCapture("' + title + '")...', false);
            google.script.run
                .withSuccessHandler(function (task) { log('quickCapture() SUCCESS:\n' + JSON.stringify(task, null, 2), false); })
                .withFailureHandler(function (error) { log('quickCapture() FAILED:\n' + (error.message || error), true); })
                .quickCapture(title, 'Test notes');
        }

        function importMloData() {
            var fileInput = document.getElementById('importFile');
            var file = fileInput.files[0];

            if (!file) {
                log('Please select a file first.', true);
                return;
            }

            log('Reading file: ' + file.name + '...', false);

            var reader = new FileReader();
            reader.onload = function (e) {
                var content = e.target.result;
                log('File read (' + content.length + ' bytes). Sending to server...', false);

                google.script.run
                    .withSuccessHandler(function (result) {
                        log('Import Result:\n' + JSON.stringify(result, null, 2), !result.success);
                    })
                    .withFailureHandler(function (error) {
                        log('Import FAILED:\n' + (error.message || error), true);
                    })
                    .importMloData(content);
            };
            reader.onerror = function (e) {
                log('Error reading file', true);
            };
            reader.readAsText(file);
        }

        function inspectProjects() {
            log('Inspecting Projects sheet...', false);
            google.script.run
                .withSuccessHandler(function (result) {
                    log('Inspection Result:\n' + JSON.stringify(result, null, 2), false);
                })
                .withFailureHandler(function (error) {
                    log('Inspection FAILED:\n' + (error.message || error), true);
                })
                .debugInspectProjectSheet();
        }

        function fixHeaders() {
            log('Updating project headers...', false);
            google.script.run
                .withSuccessHandler(function (result) {
                    log('Success: ' + result.message, false);
                })
                .withFailureHandler(function (error) {
                    log('Failed: ' + error, true);
                })
                .fixProjectHeaders();
        }

        function runMigration() {
            if (!confirm('Have you backed up your data? This will migrate all projects to the tasks sheet.')) return;
            log('Starting migration... This may take a moment.', false);
            google.script.run
                .withSuccessHandler(function (result) {
                    log('Migration Result:\n' + JSON.stringify(result, null, 2), !result.success);
                    if (result.success) {
                        log('Migration complete! Please refresh the page.', false);
                    }
                })
                .withFailureHandler(function (error) {
                    log('Migration FAILED:\n' + (error.message || error), true);
                })
                .runMigration();
        }

        function testInitialize() {
            log('Calling initializeSystem()...', false);
            google.script.run
                .withSuccessHandler(function (result) { log('initializeSystem() SUCCESS:\n' + JSON.stringify(result, null, 2), false); })
                .withFailureHandler(function (error) { log('initializeSystem() FAILED:\n' + (error.message || error), true); })
                .initializeSystem();
        }

        window.onload = function () { log('Page loaded. Run tests to diagnose issues.', false); };
    </script>
</body>

</html>